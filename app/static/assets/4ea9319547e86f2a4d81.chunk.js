"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[2251],{832:(t,e,o)=>{o.d(e,{c:()=>k,y:()=>C});var a=o(2404),r=o.n(a),l=o(2445),i=o(24002),n=o(67413),s=o(35942),c=o(14503),u=o(28027),d=o(50871),p=o(98456),f=o(48238),m=o(92123),g=o(51316),h=o(20605);const{getScale:b}=c;function _(t,e){const o=t.color_picker||{r:0,g:0,b:0,a:1},a=[o.r,o.g,o.b,255*o.a],r=t.color_scheme,l=b(r);let i={};return t.color_scheme_type===m.wP.color_breakpoints?i=(0,g.BK)(t.color_breakpoints):e.forEach(e=>{if(null!=e.cat_color&&!i.hasOwnProperty(e.cat_color)){let r;r=t.dimension?(0,d.hexToRGB)(l(e.cat_color,t.sliceId),255*o.a):a,i[e.cat_color]={color:r,enabled:!0}}}),i}const y=t=>{const e=(0,i.useRef)(null),o=(0,i.useCallback)(()=>{let e={...t.viewport};return t.formData.autozoom&&(e=(0,f.A)(e,{width:t.width,height:t.height,points:t.getPoints(t.payload.data.features||[])})),e.zoom<0&&(e.zoom=0),e},[t]),[a,r]=(0,i.useState)(_(t.formData,t.payload.data.features||[])),[n,c]=(0,i.useState)(t.payload.form_data),[g,y]=(0,i.useState)(o());(0,i.useEffect)(()=>{if(t.payload.form_data!==n){const e=t.payload.data.features||[],a=_(t.formData,e);y(o()),c(t.payload.form_data),r(a)}},[o,t,n]);const v=(0,i.useCallback)(t=>{const{current:o}=e;o&&o.setTooltip(t)},[]),C=(0,i.useCallback)((t,e,o)=>{const a=e.color_scheme,r=b(a);let l;switch(o){case m.wP.fixed_color:{l=e.color_picker||{r:0,g:0,b:0,a:100};const o=[l.r,l.g,l.b,255*l.a];return t.map(t=>({...t,color:o}))}case m.wP.categorical_palette:if(!e.dimension){const o=e.color_picker||{r:0,g:0,b:0,a:100},a=[o.r,o.g,o.b,255*o.a];return t.map(t=>({...t,color:a}))}return t.map(t=>({...t,color:(0,d.hexToRGB)(r(t.cat_color,e.slice_id))}));case m.wP.color_breakpoints:{const o=e.default_breakpoint_color?[e.default_breakpoint_color.r,e.default_breakpoint_color.g,e.default_breakpoint_color.b,255*e.default_breakpoint_color.a]:[h.DL.r,h.DL.g,h.DL.b,255*h.DL.a];return t.map(t=>{var a;const r=null==(a=e.color_breakpoints)?void 0:a.find(e=>t.metric>=e.minValue&&t.metric<=e.maxValue);if(r){const e=[r.color.r,r.color.g,r.color.b,255*r.color.a];return{...t,color:e}}return{...t,color:o}})}default:return[]}},[]),k=(0,i.useCallback)(()=>{const{getLayer:e,getHighlightLayer:o,payload:r,formData:l,onAddFilter:i,onContextMenu:n,filterState:s,setDataMask:c,emitCrossFilters:u}=t;let d=r.data.features?[...r.data.features]:[];const f=l.color_scheme_type;d=C(d,l,f),l.js_data_mutator&&(d=(0,p.A)(l.js_data_mutator)(d)),l.dimension&&(d=d.filter(t=>{var e;return null==(e=a[t.cat_color])?void 0:e.enabled}));const m={formData:l,payload:{...r,data:{...r.data,features:d}},onAddFilter:i,setTooltip:v,datasource:t.datasource,onContextMenu:n,filterState:s,setDataMask:c,emitCrossFilters:u},g=e(m);return u&&null!=s&&s.value&&o?[g,o(m)]:[g]},[C,a,t,v]),w=(0,i.useCallback)(t=>{const e=a[t],o={...a,[t]:{...e,enabled:!e.enabled}};Object.values(o).every(t=>!t.enabled)&&Object.values(o).forEach(t=>{t.enabled=!0}),r(o)},[a]),D=(0,i.useCallback)(t=>{const e={...a};Object.values(e).forEach(t=>{t.enabled=!1}),e[t].enabled=!0,r(e)},[a]);return(0,l.FD)("div",{style:{position:"relative"},children:[(0,l.Y)(s.S,{ref:e,viewport:g,layers:k(),setControlValue:t.setControlValue,mapStyle:t.formData.mapbox_style,mapboxApiAccessToken:t.mapboxApiKey,width:t.width,height:t.height}),(0,l.Y)(u.A,{forceCategorical:!0,categories:a,format:t.formData.legend_format,position:t.formData.legend_position,showSingleCategory:D,toggleCategory:w})]})},v=(0,i.memo)(y);function C(t,e,o){return(0,i.memo)(a=>{const c=(0,i.useRef)(),d=(0,n.Z)(a.formData),p=(0,n.Z)(a.filterState),m=(0,n.Z)(a.payload),[h,b]=(0,i.useState)((0,g.BK)(a.formData.color_breakpoints)||[]),[_,y]=(0,i.useState)((()=>{const{width:t,height:o,formData:r}=a;return r.autozoom?(0,f.A)(a.viewport,{width:t,height:o,points:e(a.payload.data.features)}):a.viewport})()),v=(0,i.useCallback)(t=>{const{current:e}=c;e&&(null==e||e.setTooltip(t))},[]),C=(0,i.useCallback)(e=>{const{formData:a,payload:r,onAddFilter:l,filterState:i,setDataMask:n,onContextMenu:s,emitCrossFilters:c}=e,u={formData:a,payload:r,onAddFilter:l,setTooltip:v,setDataMask:n,onContextMenu:s,filterState:i,emitCrossFilters:c},d=t(u);return c&&null!=i&&i.value&&o?[d,o(u)]:[d]},[v]);(0,i.useEffect)(()=>{const t=(0,g.BK)(a.formData.color_breakpoints);b(t)},[a]);const[k,w]=(0,i.useState)(C(a));(0,i.useEffect)(()=>{const t={...d,...p,viewport:null},e={...a.formData,...a.filterState,viewport:null};r()(t,e)&&m===a.payload||w(C(a))},[C,d,p,m,a]);const{formData:D,payload:A,setControlValue:x,height:F,width:S}=a;return(0,l.FD)("div",{style:{position:"relative"},children:[(0,l.Y)(s.S,{ref:c,mapboxApiAccessToken:A.data.mapboxApiKey,viewport:_,layers:k,mapStyle:D.mapbox_style,setControlValue:x,width:S,height:F,onViewportChange:y}),(0,l.Y)(u.A,{forceCategorical:!0,categories:h,format:a.formData.legend_format,position:a.formData.legend_position})]})})}function k(t,e,o){return function(a){const{datasource:r,formData:i,height:n,payload:s,setControlValue:c,viewport:u,width:d,setDataMask:p,filterState:f,onContextMenu:m,emitCrossFilters:g}=a;return(0,l.Y)(v,{datasource:r,formData:i,mapboxApiKey:s.data.mapboxApiKey,setControlValue:c,viewport:u,getLayer:t,getHighlightLayer:o,payload:s,getPoints:e,width:d,height:n,setDataMask:p,onContextMenu:m,filterState:f,emitCrossFilters:g})}}},49529:(t,e,o)=>{o.r(e),o.d(e,{default:()=>b,getHighlightLayer:()=>h,getLayer:()=>m,getPoints:()=>g});var a=o(2445),r=o(12928),l=o(74098),i=o(96469),n=o(92123),s=o(83860),c=o(98456),u=o(832),d=o(52480),p=o(42828),f=o(51316);const m=({formData:t,payload:e,setTooltip:o,setDataMask:n,onContextMenu:u,filterState:f,emitCrossFilters:m})=>{var g,h;const b=t,{intensity:_=1,radius_pixels:y=30,aggregation:v="SUM",js_data_mutator:C,linear_color_scheme:k}=b;let w=e.data.features;C&&(w=(0,c.A)(b.js_data_mutator)(w));const D=null==(g=(0,i.A)())||null==(g=g.get(k))?void 0:g.createLinearScale([0,6]),A=b.color_scheme_type,x=null==(h=(0,s.XC)({defaultBreakpointsColor:b.default_breakpoint_color,colorBreakpoints:b.color_breakpoints,fixedColor:b.color_picker,colorSchemeType:A,colorScale:D}))?void 0:h.reverse(),F=function(t){const e=e=>{var o,r,i,n,s,c;const u=(null==(o=t.size)?void 0:o.label)||(null==(r=t.size)?void 0:r.value)||"Weight",p=null==(i=e.coordinate)?void 0:i[0],f=null==(n=e.coordinate)?void 0:n[1],m=t.tooltip_template||t.tooltip_contents&&t.tooltip_contents.length>0,g=e.object&&Object.keys(e.object).length>0;return(0,a.FD)("div",{className:"deckgl-tooltip",children:[(0,a.Y)(d.A,{label:`${(0,l.t)("Longitude and Latitude")}: `,value:`${null==p?void 0:p.toFixed(6)}, ${null==f?void 0:f.toFixed(6)}`}),(0,a.Y)(d.A,{label:"LON: ",value:null==p?void 0:p.toFixed(6)}),(0,a.Y)(d.A,{label:"LAT: ",value:null==f?void 0:f.toFixed(6)}),(0,a.Y)(d.A,{label:`${u}: `,value:`${(null==(s=e.object)?void 0:s.weight)||(null==(c=e.object)?void 0:c.value)||"Aggregated Cell"}`}),m&&!g&&(0,a.Y)(d.A,{label:`${(0,l.t)("Note")}: `,value:(0,l.t)("Custom fields not available in aggregated heatmap cells")})]})};return o=>{var a;let r=null;if(o.coordinate&&null!=(a=o.layer)&&null!=(a=a.props)&&a.data){const[t,e]=o.coordinate;let a=1/0;for(const l of o.layer.props.data)if(l.position){const[o,i]=l.position,n=Math.sqrt(Math.pow(t-o,2)+Math.pow(e-i,2));n<a&&(a=n,r=l)}}const l={...o,object:r||o.object};return(0,p.j1)(t,e)(l)}}(b);return new r.A({id:`heatmap-layer-${b.slice_id}`,data:w,intensity:_,radiusPixels:y,colorRange:x,aggregation:v.toUpperCase(),getPosition:t=>t.position,getWeight:t=>t.weight?t.weight:1,opacity:.8,threshold:.03,...(0,s.T$)({formData:b,setTooltip:o,setTooltipContent:F,setDataMask:n,filterState:f,onContextMenu:u,emitCrossFilters:m})})};function g(t){return t.map(t=>t.position)}const h=({formData:t,filterState:e,payload:o})=>{const a=t,{intensity:l=1,radius_pixels:i=30,aggregation:s="SUM",js_data_mutator:u}=a;let d=o.data.features;u&&(d=(0,c.A)(a.js_data_mutator)(d));const p=d.filter(t=>(0,n.st)(t.position,null==e?void 0:e.value));return new r.A({id:`heatmap-layer-${a.slice_id}`,data:p,intensity:l,radiusPixels:i,colorRange:[[f.Fe[0],f.Fe[1],f.Fe[2],55],f.Fe],aggregation:s.toUpperCase(),getPosition:t=>t.position,getWeight:t=>t.weight?t.weight:1})},b=(0,u.y)(m,g,h)},78579:(t,e,o)=>{o.d(e,{Pu:()=>i,QO:()=>a,Y5:()=>r,cp:()=>n});const a=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]];function r(t,e=!1,o=Float32Array){let a;if(Number.isFinite(t[0]))a=new o(t);else{a=new o(4*t.length);let e=0;for(let o=0;o<t.length;o++){const r=t[o];a[e++]=r[0],a[e++]=r[1],a[e++]=r[2],a[e++]=Number.isFinite(r[3])?r[3]:255}}if(e)for(let t=0;t<a.length;t++)a[t]/=255;return a}const l={linear:"linear",quantile:"nearest",quantize:"nearest",ordinal:"nearest"};function i(t,e){t.setSampler({minFilter:l[e],magFilter:l[e]})}function n(t,e,o="linear"){const a=r(e,!1,Uint8Array);return t.createTexture({format:"rgba8unorm",mipmaps:!1,sampler:{minFilter:l[o],magFilter:l[o],addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},data:a,width:a.length/4,height:1})}}}]);