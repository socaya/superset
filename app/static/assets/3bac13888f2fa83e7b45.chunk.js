"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[4113],{29757:(e,a,t)=>{t.r(a),t.d(a,{default:()=>T});var s=t(2445),n=t(24002),r=t(74098),l=t(86784),i=t(20237),o=t(47263),d=t(95018),u=t(8558),c=t(94551),m=t(38961),p=t(9876),g=t(47305),h=t(51692),y=t(64457),f=t(30613),w=t(82384),b=t(29645),_=t(2801),v=t(85923),C=t(79378);const Y=async e=>C.A.delete({endpoint:`/api/v1/security/users/${e}`}),S=e=>({getFieldValue:a})=>({validator(t,s){const n=s||[],l=a(e)||[];return 0===n.length&&0===l.length?Promise.reject(new Error((0,r.t)("Please select at least one role or group"))):Promise.resolve()}});function k({show:e,onHide:a,onSave:t,roles:n,isEditMode:l=!1,user:i,groups:o}){var d,u;const{addDangerToast:c,addSuccessToast:m}=(0,y.Yf)(),p=l?["first_name","last_name","username","email"]:["first_name","last_name","username","email","password","confirmPassword"],g={...i,roles:(null==i||null==(d=i.roles)?void 0:d.map(e=>e.id))||[],groups:(null==i||null==(u=i.groups)?void 0:u.map(e=>e.id))||[]};return(0,s.Y)(f.k,{show:e,onHide:a,name:l?"Edit User":"Add User",title:(0,s.Y)(h.r,{isEditMode:l,title:l?(0,r.t)("Edit User"):(0,r.t)("Add User")}),onSave:t,formSubmitHandler:async e=>{const a=async(e,a)=>{let t=a===v.En.CREATE?(0,r.t)("There was an error creating the user. Please, try again."):(0,r.t)("There was an error updating the user. Please, try again.");if(422===e.status){const a=await e.json(),s=(null==a?void 0:a.message)||"";s.includes("duplicate key value")&&(s.includes("ab_user_username_key")?t=(0,r.t)("This username is already taken. Please choose another one."):s.includes("ab_user_email_key")&&(t=(0,r.t)("This email is already associated with an account. Please choose another one.")))}throw c(t),e};if(l){if(!i)throw new Error("User is required in edit mode");try{await(async(e,a)=>{await C.A.put({endpoint:`/api/v1/security/users/${e}`,jsonPayload:{...a}})})(i.id,e),m((0,r.t)("The user has been updated successfully."))}catch(e){await a(e,v.En.UPDATE)}}else try{await(async e=>{const{confirmPassword:a,...t}=e;null==t.active&&(t.active=!1),await C.A.post({endpoint:"/api/v1/security/users/",jsonPayload:{...t}})})(e),m((0,r.t)("The group has been created successfully."))}catch(e){await a(e,v.En.CREATE)}},requiredFields:p,initialValues:g,children:e=>(0,s.FD)(s.FK,{children:[(0,s.Y)(w.e,{name:"first_name",label:(0,r.t)("First name"),rules:[{required:!0,message:(0,r.t)("First name is required")}],children:(0,s.Y)(b.Input,{name:"first_name",placeholder:(0,r.t)("Enter the user's first name")})}),(0,s.Y)(w.e,{name:"last_name",label:(0,r.t)("Last name"),rules:[{required:!0,message:(0,r.t)("Last name is required")}],children:(0,s.Y)(b.Input,{name:"last_name",placeholder:(0,r.t)("Enter the user's last name")})}),(0,s.Y)(w.e,{name:"username",label:(0,r.t)("Username"),rules:[{required:!0,message:(0,r.t)("Username is required")}],children:(0,s.Y)(b.Input,{name:"username",placeholder:(0,r.t)("Enter the user's username")})}),(0,s.Y)(w.e,{name:"active",label:(0,r.t)("Is active?"),valuePropName:"checked",children:(0,s.Y)(b.Checkbox,{onChange:a=>{e.setFieldsValue({isActive:a})}})}),(0,s.Y)(w.e,{name:"email",label:(0,r.t)("Email"),rules:[{required:!0,message:(0,r.t)("Email is required")},{type:"email",message:(0,r.t)("Please enter a valid email address")}],children:(0,s.Y)(b.Input,{name:"email",placeholder:(0,r.t)("Enter the user's email")})}),(0,s.Y)(w.e,{name:"roles",label:(0,r.t)("Roles"),dependencies:["groups"],rules:[S("groups")],children:(0,s.Y)(_.A,{name:"roles",mode:"multiple",placeholder:(0,r.t)("Select roles"),options:n.map(e=>({value:e.id,label:e.name})),getPopupContainer:e=>e.closest(".ant-modal-content")})}),(0,s.Y)(w.e,{name:"groups",label:(0,r.t)("Groups"),dependencies:["roles"],rules:[S("roles")],children:(0,s.Y)(_.A,{name:"groups",mode:"multiple",placeholder:(0,r.t)("Select groups"),options:o.map(e=>({value:e.id,label:e.name})),getPopupContainer:e=>e.closest(".ant-modal-content")})}),!l&&(0,s.FD)(s.FK,{children:[(0,s.Y)(w.e,{name:"password",label:(0,r.t)("Password"),rules:[{required:!0,message:(0,r.t)("Password is required")}],children:(0,s.Y)(b.Input.Password,{name:"password",placeholder:"Enter the user's password"})}),(0,s.Y)(w.e,{name:"confirmPassword",label:(0,r.t)("Confirm Password"),dependencies:["password"],rules:[{required:!0,message:(0,r.t)("Please confirm your password")},({getFieldValue:e})=>({validator:(a,t)=>t&&e("password")!==t?Promise.reject(new Error((0,r.t)("Passwords do not match!"))):Promise.resolve()})],children:(0,s.Y)(b.Input.Password,{name:"confirmPassword",placeholder:(0,r.t)("Confirm the user's password")})})]})]})})}const E=e=>(0,s.Y)(k,{...e,isEditMode:!1}),D=e=>(0,s.Y)(k,{...e,isEditMode:!0});var H,F=t(35340);!function(e){e.ADD="add",e.EDIT="edit"}(H||(H={}));const P=[{label:"Yes",value:!0},{label:"No",value:!1}],T=function({user:e}){const{addDangerToast:a,addSuccessToast:t}=(0,y.Yf)(),{state:{loading:h,resourceCount:f,resourceCollection:w,bulkSelectEnabled:b},fetchData:_,refreshData:v,toggleBulkSelect:C}=(0,l.RU)("security/users",(0,r.t)("User"),a),[S,k]=(0,n.useState)({edit:!1,add:!1}),T=e=>k(a=>({...a,[e]:!0})),A=e=>k(a=>({...a,[e]:!1})),[M,q]=(0,n.useState)(null),[I,U]=(0,n.useState)(null),[L,x]=(0,n.useState)({roles:!0,groups:!0}),[z,j]=(0,n.useState)([]),[B,V]=(0,n.useState)([]),R=(0,n.useMemo)(()=>{if(!w||0===w.length)return{min:0,max:0};const e=w.map(e=>e.login_count);return{min:Math.min(...e),max:Math.max(...e)}},[w]),K=(0,n.useMemo)(()=>{if(!w||0===w.length)return{min:0,max:0};const e=w.map(e=>e.fail_login_count);return{min:Math.min(...e),max:Math.max(...e)}},[w]),N=(0,n.useMemo)(()=>(0,g.N6)(e),[e]),$=(0,n.useCallback)(()=>{(0,F.I)({endpoint:"/api/v1/security/roles/",setData:j,setLoadingState:x,loadingKey:"roles",addDangerToast:a,errorMessage:(0,r.t)("Error while fetching roles")})},[a]),O=(0,n.useCallback)(()=>{(0,F.I)({endpoint:"/api/v1/security/groups/",setData:V,setLoadingState:x,loadingKey:"groups",addDangerToast:a,errorMessage:(0,r.t)("Error while fetching groups")})},[a]);(0,n.useEffect)(()=>{$()},[$]),(0,n.useEffect)(()=>{O()},[O]);const G=[{id:"username",desc:!0}],J=(0,n.useMemo)(()=>[{accessor:"first_name",id:"first_name",Header:(0,r.t)("First name"),size:"lg",Cell:({row:{original:{first_name:e}}})=>(0,s.Y)("span",{children:e})},{accessor:"last_name",id:"last_name",Header:(0,r.t)("Last name"),size:"lg",Cell:({row:{original:{last_name:e}}})=>(0,s.Y)("span",{children:e})},{accessor:"username",id:"username",Header:(0,r.t)("Username"),size:"xxl",Cell:({row:{original:{username:e}}})=>(0,s.Y)("span",{children:e})},{accessor:"email",id:"email",Header:(0,r.t)("Email"),size:"xl",Cell:({row:{original:{email:e}}})=>(0,s.Y)("span",{children:e})},{accessor:"active",id:"active",Header:(0,r.t)("Is active?"),size:"sm",Cell:({row:{original:{active:e}}})=>(0,s.Y)("span",{children:e?"Yes":"No"})},{accessor:"roles",id:"roles",Header:(0,r.t)("Roles"),size:"lg",Cell:({row:{original:{roles:e}}})=>(0,s.Y)(d.m,{title:(null==e?void 0:e.map(e=>e.name).join(", "))||(0,r.t)("No roles"),children:(0,s.Y)("span",{children:null==e?void 0:e.map(e=>e.name).join(", ")})}),disableSortBy:!0},{accessor:"groups",Header:(0,r.t)("Groups"),id:"groups",size:"lg",Cell:({row:{original:{groups:e}}})=>(0,s.Y)(d.m,{title:(null==e?void 0:e.map(e=>e.name).join(", "))||(0,r.t)("No groups"),children:(0,s.Y)("span",{children:null==e?void 0:e.map(e=>e.name).join(", ")})}),disableSortBy:!0},{accessor:"login_count",id:"login_count",Header:(0,r.t)("Login count"),hidden:!0,Cell:({row:{original:e}})=>e.login_count},{accessor:"fail_login_count",id:"fail_login_count",Header:(0,r.t)("Fail login count"),hidden:!0,Cell:({row:{original:e}})=>e.fail_login_count},{accessor:"created_on",id:"created_on",Header:(0,r.t)("Created on"),hidden:!0,Cell:({row:{original:{created_on:e}}})=>e},{accessor:"changed_on",id:"changed_on",Header:(0,r.t)("Changed on"),hidden:!0,Cell:({row:{original:{changed_on:e}}})=>e},{accessor:"last_login",id:"last_login",Header:(0,r.t)("Last login"),hidden:!0,Cell:({row:{original:{last_login:e}}})=>e},{Cell:({row:{original:e}})=>{const a=N?[{label:"user-list-edit-action",tooltip:(0,r.t)("Edit user"),placement:"bottom",icon:"EditOutlined",onClick:()=>{q(e),T(H.EDIT)}},{label:"role-list-delete-action",tooltip:(0,r.t)("Delete user"),placement:"bottom",icon:"DeleteOutlined",onClick:()=>U(e)}]:[];return(0,s.Y)(o.D,{actions:a})},Header:(0,r.t)("Actions"),id:"actions",disableSortBy:!0,hidden:!N,size:"xl"}],[N]),Q=[];N&&Q.push({name:(0,r.t)("Bulk select"),onClick:C,buttonStyle:"secondary"},{icon:(0,s.Y)(u.F.PlusOutlined,{iconSize:"m"}),name:(0,r.t)("User"),buttonStyle:"primary",onClick:()=>{T(H.ADD)},loading:L.roles||L.groups});const W=(0,n.useMemo)(()=>[{Header:(0,r.t)("First name"),key:"first_name",id:"first_name",input:"search",operator:p.c0.Contains},{Header:(0,r.t)("Last name"),key:"last_name",id:"last_name",input:"search",operator:p.c0.Contains},{Header:(0,r.t)("Username"),key:"username",id:"username",input:"search",operator:p.c0.Contains},{Header:(0,r.t)("Email"),key:"email",id:"email",input:"search",operator:p.c0.Contains},{Header:(0,r.t)("Is active?"),key:"active",id:"active",input:"select",operator:p.c0.Equals,unfilteredLabel:(0,r.t)("All"),selects:null==P?void 0:P.map(e=>({label:e.label,value:e.value}))},{Header:(0,r.t)("Roles"),key:"roles",id:"roles",input:"select",operator:p.c0.RelationManyMany,unfilteredLabel:(0,r.t)("All"),selects:null==z?void 0:z.map(e=>({label:e.name,value:e.id})),loading:L.roles},{Header:(0,r.t)("Groups"),key:"groups",id:"groups",input:"select",operator:p.c0.RelationManyMany,unfilteredLabel:(0,r.t)("All"),selects:null==B?void 0:B.map(e=>({label:e.name,value:e.id})),loading:L.groups},{Header:(0,r.t)("Created on"),key:"created_on",id:"created_on",input:"datetime_range",operator:p.c0.Between,dateFilterValueType:"iso"},{Header:(0,r.t)("Changed on"),key:"changed_on",id:"changed_on",input:"datetime_range",operator:p.c0.Between,dateFilterValueType:"iso"},{Header:(0,r.t)("Last login"),key:"last_login",id:"last_login",input:"datetime_range",operator:p.c0.Between,dateFilterValueType:"iso"},{Header:(0,r.t)("Login count"),key:"login_count",id:"login_count",input:"numerical_range",operator:p.c0.Between,min:R.min,max:R.max},{Header:(0,r.t)("Fail login count"),key:"fail_login_count",id:"fail_login_count",input:"numerical_range",operator:p.c0.Between}],[L.roles,z,B,L.groups,R,K]),X={title:(0,r.t)("No users yet"),image:"filter-results.svg",...N&&{buttonAction:()=>{T(H.ADD)},buttonText:(0,s.FD)(s.FK,{children:[(0,s.Y)(u.F.PlusOutlined,{iconSize:"m"}),(0,r.t)("User")]})}};return(0,s.FD)(s.FK,{children:[(0,s.Y)(i.A,{name:(0,r.t)("List Users"),buttons:Q}),(0,s.Y)(E,{onHide:()=>A(H.ADD),show:S.add,onSave:()=>{v(),A(H.ADD)},roles:z,groups:B}),S.edit&&M&&(0,s.Y)(D,{user:M,show:S.edit,onHide:()=>A(H.EDIT),onSave:()=>{v(),A(H.EDIT)},roles:z,groups:B}),I&&(0,s.Y)(c.T,{description:(0,r.t)("This action will permanently delete the user."),onConfirm:()=>{I&&(async({id:e,username:s})=>{try{await Y(e),v(),U(null),t((0,r.t)("Deleted user: %s",s))}catch(e){a((0,r.t)("There was an issue deleting %s",s))}})(I)},onHide:()=>U(null),open:!0,title:(0,r.t)("Delete User?")}),(0,s.Y)(m.h,{title:(0,r.t)("Please confirm"),description:(0,r.t)("Are you sure you want to delete the selected users?"),onConfirm:e=>{const s=[];Promise.all(e.map(e=>Y(e.id).then(()=>{s.push(e.username)}).catch(t=>{a((0,r.t)("Error deleting %s",e.username))}))).then(()=>{s.length>0&&t((0,r.t)("Deleted users: %s",s.join(", ")))}).finally(()=>{v()})},children:e=>{const n=N?[{key:"delete",name:(0,r.t)("Delete"),onSelect:e,type:"danger"}]:[];return(0,s.Y)(p.uO,{className:"user-list-view",columns:J,count:f,data:w,fetchData:_,filters:W,initialSort:G,loading:h,pageSize:25,bulkActions:n,bulkSelectEnabled:b,disableBulkSelect:C,addDangerToast:a,addSuccessToast:t,emptyState:X,refreshData:v})}})]})}},30613:(e,a,t)=>{t.d(a,{k:()=>d});var s=t(2445),n=t(24002),r=t(74098),l=t(88217),i=t(65729),o=t(97163);function d({show:e,onHide:a,title:t,onSave:d,children:u,initialValues:c={},formSubmitHandler:m,bodyStyle:p={},requiredFields:g=[],name:h}){const[y]=i.l.useForm(),[f,w]=(0,n.useState)(!1),b=(0,n.useCallback)(()=>{y.resetFields(),w(!1)},[y]),[_,v]=(0,n.useState)(!0),C=(0,n.useCallback)(()=>{b(),a()},[a,b]),Y=(0,n.useCallback)(()=>{b(),d()},[d,b]),S=(0,n.useCallback)(async e=>{try{w(!0),await m(e),Y()}catch(e){console.error(e)}finally{w(!1)}},[m,Y]),k=()=>{const e=y.getFieldsError().some(({errors:e})=>e.length),a=y.getFieldsValue(),t=g.some(e=>!a[e]);v(e||t)};return(0,s.Y)(o.aF,{name:h,show:e,title:t,onHide:C,bodyStyle:p,footer:(0,s.FD)(s.FK,{children:[(0,s.Y)(l.$,{buttonStyle:"secondary",onClick:C,children:(0,r.t)("Cancel")}),(0,s.Y)(l.$,{buttonStyle:"primary",htmlType:"submit",onClick:()=>y.submit(),disabled:f||_,children:f?(0,r.t)("Saving..."):(0,r.t)("Save")})]}),children:(0,s.Y)(i.l,{form:y,layout:"vertical",onFinish:S,initialValues:c,onValuesChange:k,onFieldsChange:k,children:"function"==typeof u?u(y):u})})}},35340:(e,a,t)=>{t.d(a,{I:()=>i});var s=t(74098),n=t(79378),r=t(58561),l=t.n(r);const i=async({endpoint:e,pageSize:a=100,setData:t,filters:r,setLoadingState:i,loadingKey:o,addDangerToast:d,errorMessage:u="Error while fetching data",mapResult:c=e=>e})=>{try{const s=async t=>{const s={page_size:a,page:t};r&&(s.filters=r);const i=l().encode(s),o=await n.A.get({endpoint:`${e}?q=${i}`});return{count:o.json.count,results:o.json.result.map(c)}},i=await s(0),o=i.count,d=i.results;if(a>=o)return void t(d);const u=Math.ceil(o/a),m=Array.from({length:u-1},(e,a)=>s(a+1)),p=await Promise.all(m);t([...d,...p.flatMap(e=>e.results)])}catch(e){d((0,s.t)(u))}finally{i(e=>"boolean"!=typeof e&&{...e,[o]:!1})}}}}]);