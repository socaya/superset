"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[5926],{832:(e,t,o)=>{o.d(t,{c:()=>C,y:()=>_});var a=o(2404),i=o.n(a),r=o(2445),n=o(24002),s=o(67413),l=o(35942),c=o(14503),p=o(28027),d=o(50871),u=o(98456),g=o(48238),h=o(92123),f=o(51316),m=o(20605);const{getScale:v}=c;function y(e,t){const o=e.color_picker||{r:0,g:0,b:0,a:1},a=[o.r,o.g,o.b,255*o.a],i=e.color_scheme,r=v(i);let n={};return e.color_scheme_type===h.wP.color_breakpoints?n=(0,f.BK)(e.color_breakpoints):t.forEach(t=>{if(null!=t.cat_color&&!n.hasOwnProperty(t.cat_color)){let i;i=e.dimension?(0,d.hexToRGB)(r(t.cat_color,e.sliceId),255*o.a):a,n[t.cat_color]={color:i,enabled:!0}}}),n}const b=e=>{const t=(0,n.useRef)(null),o=(0,n.useCallback)(()=>{let t={...e.viewport};return e.formData.autozoom&&(t=(0,g.A)(t,{width:e.width,height:e.height,points:e.getPoints(e.payload.data.features||[])})),t.zoom<0&&(t.zoom=0),t},[e]),[a,i]=(0,n.useState)(y(e.formData,e.payload.data.features||[])),[s,c]=(0,n.useState)(e.payload.form_data),[f,b]=(0,n.useState)(o());(0,n.useEffect)(()=>{if(e.payload.form_data!==s){const t=e.payload.data.features||[],a=y(e.formData,t);b(o()),c(e.payload.form_data),i(a)}},[o,e,s]);const S=(0,n.useCallback)(e=>{const{current:o}=t;o&&o.setTooltip(e)},[]),_=(0,n.useCallback)((e,t,o)=>{const a=t.color_scheme,i=v(a);let r;switch(o){case h.wP.fixed_color:{r=t.color_picker||{r:0,g:0,b:0,a:100};const o=[r.r,r.g,r.b,255*r.a];return e.map(e=>({...e,color:o}))}case h.wP.categorical_palette:if(!t.dimension){const o=t.color_picker||{r:0,g:0,b:0,a:100},a=[o.r,o.g,o.b,255*o.a];return e.map(e=>({...e,color:a}))}return e.map(e=>({...e,color:(0,d.hexToRGB)(i(e.cat_color,t.slice_id))}));case h.wP.color_breakpoints:{const o=t.default_breakpoint_color?[t.default_breakpoint_color.r,t.default_breakpoint_color.g,t.default_breakpoint_color.b,255*t.default_breakpoint_color.a]:[m.DL.r,m.DL.g,m.DL.b,255*m.DL.a];return e.map(e=>{var a;const i=null==(a=t.color_breakpoints)?void 0:a.find(t=>e.metric>=t.minValue&&e.metric<=t.maxValue);if(i){const t=[i.color.r,i.color.g,i.color.b,255*i.color.a];return{...e,color:t}}return{...e,color:o}})}default:return[]}},[]),C=(0,n.useCallback)(()=>{const{getLayer:t,getHighlightLayer:o,payload:i,formData:r,onAddFilter:n,onContextMenu:s,filterState:l,setDataMask:c,emitCrossFilters:p}=e;let d=i.data.features?[...i.data.features]:[];const g=r.color_scheme_type;d=_(d,r,g),r.js_data_mutator&&(d=(0,u.A)(r.js_data_mutator)(d)),r.dimension&&(d=d.filter(e=>{var t;return null==(t=a[e.cat_color])?void 0:t.enabled}));const h={formData:r,payload:{...i,data:{...i.data,features:d}},onAddFilter:n,setTooltip:S,datasource:e.datasource,onContextMenu:s,filterState:l,setDataMask:c,emitCrossFilters:p},f=t(h);return p&&null!=l&&l.value&&o?[f,o(h)]:[f]},[_,a,e,S]),x=(0,n.useCallback)(e=>{const t=a[e],o={...a,[e]:{...t,enabled:!t.enabled}};Object.values(o).every(e=>!e.enabled)&&Object.values(o).forEach(e=>{e.enabled=!0}),i(o)},[a]),w=(0,n.useCallback)(e=>{const t={...a};Object.values(t).forEach(e=>{e.enabled=!1}),t[e].enabled=!0,i(t)},[a]);return(0,r.FD)("div",{style:{position:"relative"},children:[(0,r.Y)(l.S,{ref:t,viewport:f,layers:C(),setControlValue:e.setControlValue,mapStyle:e.formData.mapbox_style,mapboxApiAccessToken:e.mapboxApiKey,width:e.width,height:e.height}),(0,r.Y)(p.A,{forceCategorical:!0,categories:a,format:e.formData.legend_format,position:e.formData.legend_position,showSingleCategory:w,toggleCategory:x})]})},S=(0,n.memo)(b);function _(e,t,o){return(0,n.memo)(a=>{const c=(0,n.useRef)(),d=(0,s.Z)(a.formData),u=(0,s.Z)(a.filterState),h=(0,s.Z)(a.payload),[m,v]=(0,n.useState)((0,f.BK)(a.formData.color_breakpoints)||[]),[y,b]=(0,n.useState)((()=>{const{width:e,height:o,formData:i}=a;return i.autozoom?(0,g.A)(a.viewport,{width:e,height:o,points:t(a.payload.data.features)}):a.viewport})()),S=(0,n.useCallback)(e=>{const{current:t}=c;t&&(null==t||t.setTooltip(e))},[]),_=(0,n.useCallback)(t=>{const{formData:a,payload:i,onAddFilter:r,filterState:n,setDataMask:s,onContextMenu:l,emitCrossFilters:c}=t,p={formData:a,payload:i,onAddFilter:r,setTooltip:S,setDataMask:s,onContextMenu:l,filterState:n,emitCrossFilters:c},d=e(p);return c&&null!=n&&n.value&&o?[d,o(p)]:[d]},[S]);(0,n.useEffect)(()=>{const e=(0,f.BK)(a.formData.color_breakpoints);v(e)},[a]);const[C,x]=(0,n.useState)(_(a));(0,n.useEffect)(()=>{const e={...d,...u,viewport:null},t={...a.formData,...a.filterState,viewport:null};i()(e,t)&&h===a.payload||x(_(a))},[_,d,u,h,a]);const{formData:w,payload:D,setControlValue:k,height:P,width:z}=a;return(0,r.FD)("div",{style:{position:"relative"},children:[(0,r.Y)(l.S,{ref:c,mapboxApiAccessToken:D.data.mapboxApiKey,viewport:y,layers:C,mapStyle:w.mapbox_style,setControlValue:k,width:z,height:P,onViewportChange:b}),(0,r.Y)(p.A,{forceCategorical:!0,categories:m,format:a.formData.legend_format,position:a.formData.legend_position})]})})}function C(e,t,o){return function(a){const{datasource:i,formData:n,height:s,payload:l,setControlValue:c,viewport:p,width:d,setDataMask:u,filterState:g,onContextMenu:h,emitCrossFilters:f}=a;return(0,r.Y)(S,{datasource:i,formData:n,mapboxApiKey:l.data.mapboxApiKey,setControlValue:c,viewport:p,getLayer:e,getHighlightLayer:o,payload:l,getPoints:t,width:d,height:s,setDataMask:u,onContextMenu:h,filterState:g,emitCrossFilters:f})}}},85926:(e,t,o)=>{o.r(t),o.d(t,{default:()=>F,getLayer:()=>L,getPoints:()=>T});var a=o(2445),i=o(38706),r=o(531),n=o(5855),s=o(53112),l=o(63320),c=o(20272),p=o(15473),d=o(82849),u=o(78579);const g={name:"screenGrid",vs:"uniform screenGridUniforms {\n  vec2 cellSizeClipspace;\n  vec2 gridSizeClipspace;\n  vec2 colorDomain;\n} screenGrid;\n",uniformTypes:{cellSizeClipspace:"vec2<f32>",gridSizeClipspace:"vec2<f32>",colorDomain:"vec2<f32>"}};class h extends p.A{getShaders(){return super.getShaders({vs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-vertex-shader\n#define RANGE_COUNT 6\nin vec2 positions;\nin vec2 instancePositions;\nin float instanceWeights;\nin vec3 instancePickingColors;\nuniform sampler2D colorRange;\nout vec4 vColor;\nvec4 interp(float value, vec2 domain, sampler2D range) {\nfloat r = (value - domain.x) / (domain.y - domain.x);\nreturn texture(range, vec2(r, 0.5));\n}\nvoid main(void) {\nif (isnan(instanceWeights)) {\ngl_Position = vec4(0.);\nreturn;\n}\nvec2 pos = instancePositions * screenGrid.gridSizeClipspace + positions * screenGrid.cellSizeClipspace;\npos.x = pos.x - 1.0;\npos.y = 1.0 - pos.y;\ngl_Position = vec4(pos, 0., 1.);\nvColor = interp(instanceWeights, screenGrid.colorDomain, colorRange);\nvColor.a *= layer.opacity;\npicking_setPickingColor(instancePickingColors);\n}\n",fs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-fragment-shader\nprecision highp float;\nin vec4 vColor;\nout vec4 fragColor;\nvoid main(void) {\nfragColor = vColor;\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",modules:[d.A,g]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:2,type:"float32",accessor:"getBin"},instanceWeights:{size:1,type:"float32",accessor:"getWeight"}}),this.state.model=this._getModel()}updateState(e){super.updateState(e);const{props:t,oldProps:o,changeFlags:a}=e,i=this.state.model;if(o.colorRange!==t.colorRange){var r;null==(r=this.state.colorTexture)||r.destroy(),this.state.colorTexture=(0,u.cp)(this.context.device,t.colorRange,t.colorScaleType);const e={colorRange:this.state.colorTexture};i.shaderInputs.setProps({screenGrid:e})}else o.colorScaleType!==t.colorScaleType&&(0,u.Pu)(this.state.colorTexture,t.colorScaleType);if(o.cellMarginPixels!==t.cellMarginPixels||o.cellSizePixels!==t.cellSizePixels||a.viewportChanged){const{width:e,height:t}=this.context.viewport,{cellSizePixels:o,cellMarginPixels:a}=this.props,r=Math.max(o-a,0),n={gridSizeClipspace:[o/e*2,o/t*2],cellSizeClipspace:[r/e*2,r/t*2]};i.shaderInputs.setProps({screenGrid:n})}}finalizeState(e){var t;super.finalizeState(e),null==(t=this.state.colorTexture)||t.destroy()}draw({uniforms:e}){const t=this.props.colorDomain(),o=this.state.model,a={colorDomain:t};o.shaderInputs.setProps({screenGrid:a}),o.draw(this.context.renderPass)}_getModel(){return new l.K(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new c.V({topology:"triangle-strip",attributes:{positions:{value:new Float32Array([0,0,1,0,0,1,1,1]),size:2}}}),isInstanced:!0})}}h.layerName="ScreenGridCellLayer";const f=h,m={name:"binOptions",vs:"uniform binOptionsUniforms {\n  float cellSizePixels;\n} binOptions;\n",uniformTypes:{cellSizePixels:"f32"}},v={cellSizePixels:{type:"number",value:100,min:1},cellMarginPixels:{type:"number",value:2,min:0},colorRange:u.QO,colorScaleType:"linear",getPosition:{type:"accessor",value:e=>e.position},getWeight:{type:"accessor",value:1},gpuAggregation:!0,aggregation:"SUM"};class y extends s.A{getAggregatorType(){return this.props.gpuAggregation&&r.V.isSupported(this.context.device)?"gpu":"cpu"}createAggregator(e){return"cpu"!==e&&r.V.isSupported(this.context.device)?new r.V(this.context.device,{dimensions:2,channelCount:1,bufferLayout:this.getAttributeManager().getBufferLayouts({isInstanced:!1}),...super.getShaders({modules:[i.A,m],vs:"\n  in vec3 positions;\n  in vec3 positions64Low;\n  in float counts;\n  \n  void getBin(out ivec2 binId) {\n    vec4 pos = project_position_to_clipspace(positions, positions64Low, vec3(0.0));\n    vec2 screenCoords = vec2(pos.x / pos.w + 1.0, 1.0 - pos.y / pos.w) / 2.0 * project.viewportSize / project.devicePixelRatio;\n    vec2 gridCoords = floor(screenCoords / binOptions.cellSizePixels);\n    binId = ivec2(gridCoords);\n  }\n  void getValue(out float weight) {\n    weight = counts;\n  }\n  "})}):new n.M({dimensions:2,getBin:{sources:["positions"],getValue:({positions:e},t,o)=>{const a=this.context.viewport,i=a.project(e),r=o.cellSizePixels;return i[0]<0||i[0]>=a.width||i[1]<0||i[1]>=a.height?null:[Math.floor(i[0]/r),Math.floor(i[1]/r)]}},getValue:[{sources:["counts"],getValue:({counts:e})=>e}]})}initializeState(){super.initializeState(),this.getAttributeManager().add({positions:{size:3,accessor:"getPosition",type:"float64",fp64:this.use64bitPositions()},counts:{size:1,accessor:"getWeight"}})}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState(e){const t=super.updateState(e),{props:o,oldProps:a,changeFlags:i}=e,{cellSizePixels:n,aggregation:s}=o;if(t||i.dataChanged||i.updateTriggersChanged||i.viewportChanged||s!==a.aggregation||n!==a.cellSizePixels){const{width:e,height:t}=this.context.viewport,{aggregator:o}=this.state;o instanceof r.V&&o.setProps({binIdRange:[[0,Math.ceil(e/n)],[0,Math.ceil(t/n)]]}),o.setProps({pointCount:this.getNumInstances(),operations:[s],binOptions:{cellSizePixels:n}})}return i.viewportChanged&&this.state.aggregator.setNeedsUpdate(),t}onAttributeChange(e){const{aggregator:t}=this.state;switch(e){case"positions":t.setNeedsUpdate();break;case"counts":t.setNeedsUpdate(0)}}renderLayers(){const{aggregator:e}=this.state,t=this.getSubLayerClass("cells",f),o=e.getBins(),a=e.getResult(0);return new t(this.props,this.getSubLayerProps({id:"cell-layer"}),{data:{length:e.binCount,attributes:{getBin:o,getWeight:a}},dataComparator:(e,t)=>e.length===t.length,updateTriggers:{getBin:[o],getWeight:[a]},parameters:{depthWriteEnabled:!1,...this.props.parameters},colorDomain:()=>this.props.colorDomain||e.getResultDomain(0),extensions:[]})}getPickingInfo(e){const t=e.info,{index:o}=t;if(o>=0){const e=this.state.aggregator.getBin(o);let a;e&&(a={col:e.id[0],row:e.id[1],value:e.value[0],count:e.count},e.pointIndices&&(a.pointIndices=e.pointIndices,a.points=Array.isArray(this.props.data)?e.pointIndices.map(e=>this.props.data[e]):[])),t.object=a}return t}}y.layerName="ScreenGridLayer",y.defaultProps=v;const b=y;var S=o(81465),_=o(74098),C=o(14503),x=o(92123),w=o(98456),D=o(83860),k=o(52480),P=o(832),z=o(51316),A=o(42828);const M=S.I4.div`
  margin-top: ${({theme:e})=>e.sizeUnit}px;
  font-size: ${({theme:e})=>e.fontSizeSM}px;
  color: ${({theme:e})=>e.colorTextSecondary};
`;function T(e){return e.map(e=>e.position)}const L=function({formData:e,setDataMask:t,filterState:o,onContextMenu:i,payload:r,setTooltip:n,emitCrossFilters:s}){const l=e,c=l.color_scheme,p=C.getScale(c);let d=r.data.features;l.js_data_mutator&&(d=(0,w.A)(l.js_data_mutator)(d));const u=l.color_scheme_type,g=(0,D.XC)({defaultBreakpointsColor:l.default_breakpoint_color,colorBreakpoints:l.color_breakpoints,fixedColor:l.color_picker,colorSchemeType:u,colorScale:p}),h=l.grid_size||50,f=new Map;d.forEach(e=>{const{position:t}=e;if(t){const o=`${Math.floor(t[0]/(.01*h))},${Math.floor(t[1]/(.01*h))}`;f.has(o)||f.set(o,[]),f.get(o).push(e)}});const m=(0,A.j1)(l,e=>function(e,t){var o,i,r,n,s,l;const c=(null==(o=t.size)?void 0:o.label)||(null==(i=t.size)?void 0:i.value)||"Weight",p=e.points||[],d=p.length||0;return(0,a.FD)("div",{className:"deckgl-tooltip",children:[A.EO.centroid(e),(0,a.Y)(k.A,{label:(0,_.t)("Longitude and Latitude")+": ",value:`${null==e||null==(r=e.coordinate)?void 0:r[0]}, ${null==e||null==(n=e.coordinate)?void 0:n[1]}`}),(0,a.Y)(k.A,{label:(0,_.t)("Weight")+": ",value:`${null==(s=e.object)?void 0:s.value}`}),(0,a.Y)(k.A,{label:`${c}: `,value:`${null==(l=e.object)?void 0:l.cellWeight}`}),(0,a.Y)(k.A,{label:"Points: ",value:`${d} records`}),p.length>0&&p.length<=3&&(0,a.FD)("div",{style:{marginTop:8,fontSize:"12px"},children:[(0,a.Y)("strong",{children:"Records:"}),p.slice(0,3).map((e,t)=>(0,a.Y)("div",{style:{marginTop:4,paddingLeft:"8px"},children:Object.entries(e).map(([e,t])=>"position"!==e&&"weight"!==e&&"__timestamp"!==e&&"points"!==e?(0,a.FD)("span",{style:{marginRight:"8px"},children:[(0,a.FD)("strong",{children:[e,":"]})," ",String(t)]},e):null)},t))]}),p.length>3&&(0,a.FD)(M,{children:["... and ",p.length-3," more records"]})]})}(e,l));return new b({id:`screengrid-layer-${l.slice_id}`,data:d,cellSizePixels:l.grid_size,colorDomain:u===x.wP.color_breakpoints&&g?[0,g.length]:void 0,colorRange:"default"===u?[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]]:g,outline:!1,...(0,D.T$)({formData:l,setDataMask:t,setTooltip:n,setTooltipContent:m,filterState:o,onContextMenu:i,emitCrossFilters:s}),getWeight:e=>e.weight||0,colorScaleType:"default"===u?"linear":"quantize",onHover:e=>{if(e.picked){const t=e.coordinate,o=`${Math.floor(t[0]/(.01*h))},${Math.floor(t[1]/(.01*h))}`,a=f.get(o)||[],i={...e,object:{...e.object,points:a}};n({content:m(i),x:e.x,y:e.y})}else n(null);return!0},pickable:!0,opacity:null!=o&&o.value?.3:1})},F=(0,P.y)(L,T,function({formData:e,filterState:t,payload:o}){const a=e;let i=o.data.features;a.js_data_mutator&&(i=(0,w.A)(a.js_data_mutator)(i));const r=i.filter(e=>(0,x.st)(e.position,null==t?void 0:t.value));return new b({id:`screengrid-highlight-layer-${e.slice_id}`,data:r,cellSizePixels:e.grid_size,colorDomain:[0,1],colorRange:[z.LC,z.Fe],outline:!1,getWeight:e=>e.weight||0,colorScaleType:"quantize"})})}}]);