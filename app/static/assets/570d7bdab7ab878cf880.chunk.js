"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[7883],{832:(t,e,o)=>{o.d(e,{c:()=>D,y:()=>k});var a=o(2404),r=o.n(a),l=o(2445),n=o(24002),i=o(67413),s=o(35942),c=o(14503),u=o(28027),d=o(50871),p=o(98456),f=o(48238),h=o(92123),m=o(51316),g=o(20605);const{getScale:b}=c;function _(t,e){const o=t.color_picker||{r:0,g:0,b:0,a:1},a=[o.r,o.g,o.b,255*o.a],r=t.color_scheme,l=b(r);let n={};return t.color_scheme_type===h.wP.color_breakpoints?n=(0,m.BK)(t.color_breakpoints):e.forEach(e=>{if(null!=e.cat_color&&!n.hasOwnProperty(e.cat_color)){let r;r=t.dimension?(0,d.hexToRGB)(l(e.cat_color,t.sliceId),255*o.a):a,n[e.cat_color]={color:r,enabled:!0}}}),n}const y=t=>{const e=(0,n.useRef)(null),o=(0,n.useCallback)(()=>{let e={...t.viewport};return t.formData.autozoom&&(e=(0,f.A)(e,{width:t.width,height:t.height,points:t.getPoints(t.payload.data.features||[])})),e.zoom<0&&(e.zoom=0),e},[t]),[a,r]=(0,n.useState)(_(t.formData,t.payload.data.features||[])),[i,c]=(0,n.useState)(t.payload.form_data),[m,y]=(0,n.useState)(o());(0,n.useEffect)(()=>{if(t.payload.form_data!==i){const e=t.payload.data.features||[],a=_(t.formData,e);y(o()),c(t.payload.form_data),r(a)}},[o,t,i]);const C=(0,n.useCallback)(t=>{const{current:o}=e;o&&o.setTooltip(t)},[]),k=(0,n.useCallback)((t,e,o)=>{const a=e.color_scheme,r=b(a);let l;switch(o){case h.wP.fixed_color:{l=e.color_picker||{r:0,g:0,b:0,a:100};const o=[l.r,l.g,l.b,255*l.a];return t.map(t=>({...t,color:o}))}case h.wP.categorical_palette:if(!e.dimension){const o=e.color_picker||{r:0,g:0,b:0,a:100},a=[o.r,o.g,o.b,255*o.a];return t.map(t=>({...t,color:a}))}return t.map(t=>({...t,color:(0,d.hexToRGB)(r(t.cat_color,e.slice_id))}));case h.wP.color_breakpoints:{const o=e.default_breakpoint_color?[e.default_breakpoint_color.r,e.default_breakpoint_color.g,e.default_breakpoint_color.b,255*e.default_breakpoint_color.a]:[g.DL.r,g.DL.g,g.DL.b,255*g.DL.a];return t.map(t=>{var a;const r=null==(a=e.color_breakpoints)?void 0:a.find(e=>t.metric>=e.minValue&&t.metric<=e.maxValue);if(r){const e=[r.color.r,r.color.g,r.color.b,255*r.color.a];return{...t,color:e}}return{...t,color:o}})}default:return[]}},[]),D=(0,n.useCallback)(()=>{const{getLayer:e,getHighlightLayer:o,payload:r,formData:l,onAddFilter:n,onContextMenu:i,filterState:s,setDataMask:c,emitCrossFilters:u}=t;let d=r.data.features?[...r.data.features]:[];const f=l.color_scheme_type;d=k(d,l,f),l.js_data_mutator&&(d=(0,p.A)(l.js_data_mutator)(d)),l.dimension&&(d=d.filter(t=>{var e;return null==(e=a[t.cat_color])?void 0:e.enabled}));const h={formData:l,payload:{...r,data:{...r.data,features:d}},onAddFilter:n,setTooltip:C,datasource:t.datasource,onContextMenu:i,filterState:s,setDataMask:c,emitCrossFilters:u},m=e(h);return u&&null!=s&&s.value&&o?[m,o(h)]:[m]},[k,a,t,C]),v=(0,n.useCallback)(t=>{const e=a[t],o={...a,[t]:{...e,enabled:!e.enabled}};Object.values(o).every(t=>!t.enabled)&&Object.values(o).forEach(t=>{t.enabled=!0}),r(o)},[a]),w=(0,n.useCallback)(t=>{const e={...a};Object.values(e).forEach(t=>{t.enabled=!1}),e[t].enabled=!0,r(e)},[a]);return(0,l.FD)("div",{style:{position:"relative"},children:[(0,l.Y)(s.S,{ref:e,viewport:m,layers:D(),setControlValue:t.setControlValue,mapStyle:t.formData.mapbox_style,mapboxApiAccessToken:t.mapboxApiKey,width:t.width,height:t.height}),(0,l.Y)(u.A,{forceCategorical:!0,categories:a,format:t.formData.legend_format,position:t.formData.legend_position,showSingleCategory:w,toggleCategory:v})]})},C=(0,n.memo)(y);function k(t,e,o){return(0,n.memo)(a=>{const c=(0,n.useRef)(),d=(0,i.Z)(a.formData),p=(0,i.Z)(a.filterState),h=(0,i.Z)(a.payload),[g,b]=(0,n.useState)((0,m.BK)(a.formData.color_breakpoints)||[]),[_,y]=(0,n.useState)((()=>{const{width:t,height:o,formData:r}=a;return r.autozoom?(0,f.A)(a.viewport,{width:t,height:o,points:e(a.payload.data.features)}):a.viewport})()),C=(0,n.useCallback)(t=>{const{current:e}=c;e&&(null==e||e.setTooltip(t))},[]),k=(0,n.useCallback)(e=>{const{formData:a,payload:r,onAddFilter:l,filterState:n,setDataMask:i,onContextMenu:s,emitCrossFilters:c}=e,u={formData:a,payload:r,onAddFilter:l,setTooltip:C,setDataMask:i,onContextMenu:s,filterState:n,emitCrossFilters:c},d=t(u);return c&&null!=n&&n.value&&o?[d,o(u)]:[d]},[C]);(0,n.useEffect)(()=>{const t=(0,m.BK)(a.formData.color_breakpoints);b(t)},[a]);const[D,v]=(0,n.useState)(k(a));(0,n.useEffect)(()=>{const t={...d,...p,viewport:null},e={...a.formData,...a.filterState,viewport:null};r()(t,e)&&h===a.payload||v(k(a))},[k,d,p,h,a]);const{formData:w,payload:M,setControlValue:S,height:x,width:A}=a;return(0,l.FD)("div",{style:{position:"relative"},children:[(0,l.Y)(s.S,{ref:c,mapboxApiAccessToken:M.data.mapboxApiKey,viewport:_,layers:D,mapStyle:w.mapbox_style,setControlValue:S,width:A,height:x,onViewportChange:y}),(0,l.Y)(u.A,{forceCategorical:!0,categories:g,format:a.formData.legend_format,position:a.formData.legend_position})]})})}function D(t,e,o){return function(a){const{datasource:r,formData:n,height:i,payload:s,setControlValue:c,viewport:u,width:d,setDataMask:p,filterState:f,onContextMenu:h,emitCrossFilters:m}=a;return(0,l.Y)(C,{datasource:r,formData:n,mapboxApiKey:s.data.mapboxApiKey,setControlValue:c,viewport:u,getLayer:t,getHighlightLayer:o,payload:s,getPoints:e,width:d,height:i,setDataMask:p,onContextMenu:h,filterState:f,emitCrossFilters:m})}}},4291:(t,e,o)=>{function a({dataBounds:t,getBinId:e,padding:o=0}){const a=[t[0],t[1],[t[0][0],t[1][1]],[t[1][0],t[0][1]]].map(t=>e(t)),r=Math.min(...a.map(t=>t[0]))-o,l=Math.min(...a.map(t=>t[1]))-o;return[[r,Math.max(...a.map(t=>t[0]))+o+1],[l,Math.max(...a.map(t=>t[1]))+o+1]]}o.d(e,{O:()=>a})},83177:(t,e,o)=>{o.r(e),o.d(e,{default:()=>_,getHighlightLayer:()=>b,getLayer:()=>m,getPoints:()=>g});var a=o(2445),r=o(15653),l=o(43850),n=o(74098),i=o(83860),s=o(98456),c=o(832),u=o(52480),d=o(42828),p=o(51316);function f(t){var e;return(0,a.FD)("div",{className:"deckgl-tooltip",children:[d.EO.centroid(t),(0,a.Y)(u.A,{label:(0,n.t)("Threshold: "),value:`${null==t||null==(e=t.object)||null==(e=e.contour)?void 0:e.threshold}`})]})}function h(t){var e;return(0,a.FD)("div",{className:"deckgl-tooltip",children:[(0,a.Y)(u.A,{label:(0,n.t)("Centroid (Longitude and Latitude): "),value:`(${null==t?void 0:t.coordinate[0]}, ${null==t?void 0:t.coordinate[1]})`}),(0,a.Y)(u.A,{label:(0,n.t)("Threshold: "),value:`${null==t||null==(e=t.object)||null==(e=e.contour)?void 0:e.threshold}`})]})}const m=function({formData:t,payload:e,filterState:o,setDataMask:a,onContextMenu:l,setTooltip:n,emitCrossFilters:c}){const u=t,{aggregation:p="SUM",js_data_mutator:h,contours:m,cellSize:g="200"}=u;let b=e.data.features;const _=new Map;b.forEach(t=>{if(t.position){var e;const o=`${Math.floor(1e3*t.position[0])},${Math.floor(1e3*t.position[1])}`;_.has(o)||_.set(o,[]),null==(e=_.get(o))||e.push(t.originalData||t)}});const y=null==m?void 0:m.map(t=>{const{lowerThreshold:e,upperThreshold:o,color:a,strokeWidth:r}=t;return o?{threshold:[e,o],color:[a.r,a.g,a.b]}:{threshold:e,color:[a.r,a.g,a.b],strokeWidth:r}});return h&&(b=(0,s.A)(u.js_data_mutator)(b)),new r.A({id:`contourLayer-${u.slice_id}`,data:b,contours:y,cellSize:Number(g||"200"),aggregation:p.toUpperCase(),getPosition:t=>t.position,getWeight:t=>t.weight||0,...(0,i.T$)({formData:u,setTooltip:n,setTooltipContent:t=>{const e=[];if(t.coordinate){const o=`${Math.floor(1e3*t.coordinate[0])},${Math.floor(1e3*t.coordinate[1])}`,a=_.get(o)||[];e.push(...a);for(let o=-1;o<=1;o+=1)for(let a=-1;a<=1;a+=1)if(0!==o||0!==a){const r=`${Math.floor(1e3*t.coordinate[0])+o},${Math.floor(1e3*t.coordinate[1])+a}`,l=_.get(r)||[];e.push(...l)}if(e.length>0){const o={...t.object,nearbyPoints:e.slice(0,5),totalPoints:e.length,...e[0]};Object.assign(t,{object:o})}}return(0,d.j1)(u,f)(t)},onContextMenu:l,setDataMask:a,filterState:o,emitCrossFilters:c})})};function g(t){return t.map(t=>t.position)}const b=function({formData:t,filterState:e,setDataMask:o,onContextMenu:a,setTooltip:r,emitCrossFilters:n}){const s=t,c=null==e?void 0:e.value[0],u=null==e?void 0:e.value[1],d=c[0],f=u[0],m=c[1],g=u[1],b=[[d,m],[f,m],[f,g],[d,g],[d,m]];return new l.A({id:`contour-highlight-layer-${s.slice_id}`,data:[{polygon:b}],getPolygon:t=>t.polygon,getFillColor:[p.Fe[0],p.Fe[1],p.Fe[2],100],getLineColor:p.Fe,getLineWidth:4,filled:!0,stroked:!0,...(0,i.T$)({formData:s,setTooltip:r,setTooltipContent:h,onContextMenu:a,setDataMask:o,filterState:e,emitCrossFilters:n})})},_=(0,c.y)(m,g,b)}}]);