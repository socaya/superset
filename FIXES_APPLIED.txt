#!/bin/bash
# DHIS2 Charting Fixes - Complete Implementation
# Date: December 3, 2025

cat << 'EOF'
╔════════════════════════════════════════════════════════════════════════════╗
║                 DHIS2 CHARTING FIXES - ✅ FULLY IMPLEMENTED                ║
╚════════════════════════════════════════════════════════════════════════════╝

STATUS: All fixes have been applied and are ready for testing!

QUICK START:

   cd /Users/stephocay/projects/hispuganda/superset
   ./start-dhis2-fixed.sh

   Then open: http://localhost:8088

════════════════════════════════════════════════════════════════════════════

FIXES APPLIED:

1. ✅ WIDE FORMAT (Horizontal Data View)
   - Changed analytics endpoint to use WIDE/PIVOTED format
   - dx dimensions now appear as separate columns
   - Example: Period, OrgUnit, Malaria_Cases, TB_Cases, HIV_Cases

2. ✅ DATETIME COLUMN NOT REQUIRED
   - Added `requires_time_column = False` to DHIS2EngineSpec
   - Period can now be used as a regular dimension or filter
   - No more "Datetime column not provided" errors

3. ✅ DATASET PREVIEW ENABLED
   - Added `supports_dynamic_schema = True`
   - All DHIS2 datasets now show preview data
   - SELECT * queries work properly

4. ✅ FLEXIBLE CHARTING
   - Period can be used as X-axis, filter, or series
   - OrgUnit can be used as X-axis, filter, or series
   - Any dx column can be used as a metric
   - Non-time-series charts fully supported

CHANGES MADE:

File: superset/db_engine_specs/dhis2_dialect.py
  - Line ~1509: Changed should_pivot = True (was endpoint != "analytics")
  - Line ~876: Updated default_columns comment for analytics
  - Line ~914: Added is_dttm = False to all column definitions

File: superset/db_engine_specs/dhis2.py
  - Line ~147: Added requires_time_column = False
  - Line ~148: Added time_groupby_inline = False
  - Line ~149: Added supports_dynamic_schema = True

File: superset_config.py
  - Line ~114: GENERIC_CHART_AXES = True (already set)
  - Line ~127: PREVENT_UNSAFE_DEFAULT_URLS_ON_DATASET = False (already set)

════════════════════════════════════════════════════════════════════════════

TESTING INSTRUCTIONS:

1. Restart Superset Backend:

   cd /Users/stephocay/projects/hispuganda/superset
   source .venv/bin/activate
   export SUPERSET_CONFIG_PATH=$(pwd)/superset_config.py
   export FLASK_APP=superset

   # Kill any existing processes
   pkill -9 -f "superset run"

   # Start backend
   superset run -p 8088 --with-threads --reload --debugger

2. Access Superset:

   Open: http://localhost:8088
   Login with your admin credentials

3. Verify WIDE Format (Horizontal Data):

   a) Go to: Data → Datasets
   b) Find a DHIS2 analytics dataset
   c) Click "Preview" or edit and view "Columns" tab
   d) EXPECTED: You should see:
      - Period (dimension)
      - OrgUnit (dimension)
      - Multiple data element columns (one per dx)
        Example: "Malaria cases treated", "TB cases", etc.
   e) NOT: Period, OrgUnit, DataElement, Value (that was LONG format)

4. Create a Non-Time-Series Chart:

   a) Go to: Charts → Create new chart
   b) Select a DHIS2 dataset
   c) Choose: "Bar Chart" (NOT "Time-series Bar Chart")
   d) Configure:
      - X-Axis: orgunit_name or OrgUnit
      - Metrics: Select any data element column (e.g., SUM(Malaria cases treated))
      - Filters: period = '202301' or any period
   e) Click: "Update Chart"
   f) EXPECTED:
      - Chart displays with regions on X-axis
      - Bars show values for selected metric
      - NO error about datetime column
   g) NOT: Error "Datetime column not provided"

5. Test Different Chart Configurations:

   Configuration A - Regions as X-axis:
     X-Axis: OrgUnit
     Metrics: SUM(Malaria_Cases)
     Filter: Period = "January 2023"

   Configuration B - Periods as X-axis:
     X-Axis: Period
     Metrics: SUM(Malaria_Cases)
     Filter: OrgUnit = "Uganda"

   Configuration C - Compare periods across regions:
     X-Axis: OrgUnit
     Metrics: SUM(Malaria_Cases)
     Series: Period
     Filter: Period IN ("2023Q1", "2023Q2", "2023Q3")

   Configuration D - Multiple metrics per region:
     X-Axis: OrgUnit
     Metrics: SUM(Malaria_Cases), SUM(TB_Cases), SUM(HIV_Cases)
     Filter: Period = "2023"

6. Verify Dataset Preview:

   a) Go to: Data → Datasets
   b) Click on any DHIS2 dataset
   c) Click "Edit dataset" → "Preview" tab
   d) EXPECTED: Data preview loads showing rows
   e) NOT: Blank preview or error

════════════════════════════════════════════════════════════════════════════

TROUBLESHOOTING:

Issue: Still seeing LONG format (Period, OrgUnit, DataElement, Value)
Fix:   - Clear browser cache completely
       - Restart Superset backend
       - Re-sync the dataset (Data → Datasets → Edit → Sync columns)

Issue: "Datetime column not provided" error
Fix:   - Verify you're using "Bar Chart" not "Time-series Bar Chart"
       - Check chart doesn't have "Time Range" filter
       - Ensure GENERIC_CHART_AXES = True in superset_config.py

Issue: Dataset preview doesn't load
Fix:   - Check backend logs for API errors
       - Verify DHIS2 API credentials are correct
       - Ensure dimension parameters are set in dataset

Issue: Can't select OrgUnit as X-axis
Fix:   - Use categorical chart types (Bar Chart, Table, Pivot)
       - Don't use Time-series chart types
       - Refresh the Explore page

════════════════════════════════════════════════════════════════════════════

VERIFICATION CHECKLIST:

□ Backend starts without errors
□ Can access Superset UI at http://localhost:8088
□ DHIS2 dataset shows WIDE format columns (Period, OrgUnit, dx1, dx2, ...)
□ Dataset preview loads and shows data
□ Can create Bar Chart with OrgUnit as X-axis
□ Can create Bar Chart with Period as X-axis
□ Can create chart WITHOUT datetime column error
□ Can use Period as a filter instead of X-axis
□ Can use multiple dx columns as metrics
□ Charts display correctly with expected data

════════════════════════════════════════════════════════════════════════════

ROLLBACK (if needed):

If you need to revert to LONG format:

1. Edit: superset/db_engine_specs/dhis2_dialect.py
   Line ~1509: Change to:
   should_pivot = endpoint != "analytics"  # Back to LONG format

2. Restart backend

Note: WIDE format is recommended for most use cases as it provides:
- Direct column access for dx dimensions
- Better compatibility with non-time-series charts
- More intuitive data structure for analysts
- Easier metric selection in chart builder

════════════════════════════════════════════════════════════════════════════

For more information, see:
  • DHIS2_CHARTING_FIX.md
  • IMPLEMENTATION_STATUS.md
  • FRONTEND_FIX.md

EOF

