"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[5282],{11173:(e,t,s)=>{s.d(t,{L:()=>i});const n={};function i(e="id"){return n[e]=n[e]||1,`${e}-${n[e]++}`}},46190:(e,t,s)=>{s.d(t,{L:()=>i});const n={};function i(e="id"){return n[e]=n[e]||1,`${e}-${n[e]++}`}},49676:(e,t,s)=>{s.d(t,{h:()=>i});var n=s(65618);class i extends n.F{get[Symbol.toStringTag](){return"Buffer"}constructor(e,t){const s={...t};(t.usage||0)&i.INDEX&&!t.indexType&&(t.data instanceof Uint32Array?s.indexType="uint32":t.data instanceof Uint16Array&&(s.indexType="uint16")),delete s.data,super(e,s,i.defaultProps),this.usage=void 0,this.indexType=void 0,this.updateTimestamp=void 0,this.debugData=new ArrayBuffer(0),this.usage=s.usage||0,this.indexType=s.indexType,this.updateTimestamp=e.incrementTimestamp()}clone(e){return this.device.createBuffer({...this.props,...e})}readSyncWebGL(e,t){throw new Error("not implemented")}_setDebugData(e,t,s){const n=ArrayBuffer.isView(e)?e.buffer:e,r=Math.min(e?e.byteLength:s,i.DEBUG_DATA_MAX_LENGTH);null===n?this.debugData=new ArrayBuffer(r):0===t&&s===n.byteLength?this.debugData=n.slice(0,r):this.debugData=n.slice(t,t+r)}}i.defaultProps={...n.F.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",mappedAtCreation:!1},i.MAP_READ=1,i.MAP_WRITE=2,i.COPY_SRC=4,i.COPY_DST=8,i.INDEX=16,i.VERTEX=32,i.UNIFORM=64,i.STORAGE=128,i.INDIRECT=256,i.QUERY_RESOLVE=512,i.DEBUG_DATA_MAX_LENGTH=32},63320:(e,t,s)=>{s.d(t,{K:()=>Pe});const n=new(s(95302).t)({id:"luma.gl"});class i{constructor(e){this.bufferLayouts=void 0,this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find(t=>t.name===e)||null}getAttributeNamesForBuffer(e){var t;return e.attributes?null==(t=e.attributes)?void 0:t.map(e=>e.attribute):[e.name]}mergeBufferLayouts(e,t){const s=[...e];for(const e of t){const t=s.findIndex(t=>t.name===e.name);t<0?s.push(e):s[t]=e}return s}getBufferIndex(e){const t=this.bufferLayouts.findIndex(t=>t.name===e);return-1===t&&n.warn(`BufferLayout: Missing buffer for "${e}".`)(),t}}var r=s(49676);function o(e){return Array.isArray(e)?0===e.length||"number"==typeof e[0]:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}(e)}class a{constructor(e){if(this.name=void 0,this.uniforms={},this.modifiedUniforms={},this.modified=!0,this.bindingLayout={},this.needsRedraw="initialized",this.name=(null==e?void 0:e.name)||"unnamed",null!=e&&e.name&&null!=e&&e.shaderLayout){var t;const s=null==e||null==(t=e.shaderLayout.bindings)?void 0:t.find(t=>"uniform"===t.type&&t.name===(null==e?void 0:e.name));if(!s)throw new Error(null==e?void 0:e.name);const n=s;for(const e of n.uniforms||[])this.bindingLayout[e.name]=e}}setUniforms(e){for(const[t,s]of Object.entries(e))this._setUniform(t,s),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${s}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){var s;(function(e,t){if(e!==t)return!1;const s=e,n=t;if(!o(s))return!1;if(o(n)&&s.length===n.length)for(let e=0;e<s.length;++e)if(n[e]!==s[e])return!1;return!0})(this.uniforms[e],t)||(this.uniforms[e]=o(s=t)?s.slice():s,this.modifiedUniforms[e]=!0,this.modified=!0)}}const u={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function d(e){return u[e]}function l(e,t){switch(t){case 1:return e;case 2:return e+e%2;default:return e+(4-e%4)%4}}let c;function f(e){return(!c||c.byteLength<e)&&(c=new ArrayBuffer(e)),c}class h{constructor(e){this.layout={},this.byteLength=void 0;let t=0;for(const[s,n]of Object.entries(e)){const e=d(n),{type:i,components:r}=e;t=l(t,r);const o=t;t+=r,this.layout[s]={type:i,size:r,offset:o}}t+=(4-t%4)%4;const s=4*t;this.byteLength=Math.max(s,1024)}getData(e){const t=f(Math.max(this.byteLength,1024)),s={i32:new Int32Array(t),u32:new Uint32Array(t),f32:new Float32Array(t),f16:new Uint16Array(t)};for(const[t,i]of Object.entries(e)){const e=this.layout[t];if(!e){n.warn(`Supplied uniform value ${t} not present in uniform block layout`)();continue}const{type:r,size:a,offset:u}=e,d=s[r];if(1===a){if("number"!=typeof i&&"boolean"!=typeof i){n.warn(`Supplied value for single component uniform ${t} is not a number: ${i}`)();continue}d[u]=Number(i)}else{if(!o(i)){n.warn(`Supplied value for multi component / array uniform ${t} is not a numeric array: ${i}`)();continue}d.set(i,u)}}return new Uint8Array(t)}has(e){return Boolean(this.layout[e])}get(e){return this.layout[e]}}class p{constructor(e){this.uniformBlocks=new Map,this.uniformBufferLayouts=new Map,this.uniformBuffers=new Map;for(const[t,s]of Object.entries(e)){const e=t,n=new h(s.uniformTypes||{});this.uniformBufferLayouts.set(e,n);const i=new a({name:t});i.setUniforms(s.defaultUniforms||{}),this.uniformBlocks.set(e,i)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){for(const[s,n]of Object.entries(e)){var t;null==(t=this.uniformBlocks.get(s))||t.setUniforms(n)}this.updateUniformBuffers()}getUniformBufferByteLength(e){var t;return(null==(t=this.uniformBufferLayouts.get(e))?void 0:t.byteLength)||0}getUniformBufferData(e){var t,s;const n=(null==(t=this.uniformBlocks.get(e))?void 0:t.getAllUniforms())||{};return null==(s=this.uniformBufferLayouts.get(e))?void 0:s.getData(n)}createUniformBuffer(e,t,s){s&&this.setUniforms(s);const n=this.getUniformBufferByteLength(t),i=e.createBuffer({usage:r.h.UNIFORM|r.h.COPY_DST,byteLength:n}),o=this.getUniformBufferData(t);return i.write(o),i}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){const s=this.getUniformBufferByteLength(t),n=e.createBuffer({usage:r.h.UNIFORM|r.h.COPY_DST,byteLength:s});this.uniformBuffers.set(t,n)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(const t of this.uniformBlocks.keys()){const s=this.updateUniformBuffer(t);e||=s}return e&&n.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){const t=this.uniformBlocks.get(e);let s=this.uniformBuffers.get(e),i=!1;if(s&&null!=t&&t.needsRedraw){var r,o;i||=t.needsRedraw;const a=this.getUniformBufferData(e);s=this.uniformBuffers.get(e),null==(r=s)||r.write(a);const u=null==(o=this.uniformBlocks.get(e))?void 0:o.getAllUniforms();n.log(4,`Writing to uniform buffer ${String(e)}`,a,u)()}return i}}var m=s(65618);class g extends m.F{get[Symbol.toStringTag](){return"TextureView"}constructor(e,t){super(e,t,g.defaultProps)}}g.defaultProps={...m.F.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0};class y extends m.F{get[Symbol.toStringTag](){return"Texture"}toString(){return`Texture(${this.id},${this.format},${this.width}x${this.height})`}constructor(e,t){if(super(e,t=y.normalizeProps(e,t),y.defaultProps),this.dimension=void 0,this.format=void 0,this.width=void 0,this.height=void 0,this.depth=void 0,this.mipLevels=void 0,this.updateTimestamp=void 0,this.dimension=this.props.dimension,this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,void 0===this.props.width||void 0===this.props.height){const e=y.getTextureDataSize(this.props.data);this.width=(null==e?void 0:e.width)||1,this.height=(null==e?void 0:e.height)||1}this.props.mipmaps&&void 0===this.props.mipLevels&&(this.props.mipLevels="pyramid"),this.mipLevels="pyramid"===this.props.mipLevels?y.getMipLevelCount(this.width,this.height):this.props.mipLevels||1,this.updateTimestamp=e.incrementTimestamp()}clone(e){return this.device.createTexture({...this.props,...e})}static isExternalImage(e){return"undefined"!=typeof ImageData&&e instanceof ImageData||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas}static getExternalImageSize(e){if("undefined"!=typeof ImageData&&e instanceof ImageData||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)return{width:e.width,height:e.height};if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement)return{width:e.naturalWidth,height:e.naturalHeight};if("undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement)return{width:e.videoWidth,height:e.videoHeight};if("undefined"!=typeof VideoFrame&&e instanceof VideoFrame)return{width:e.displayWidth,height:e.displayHeight};throw new Error("Unknown image type")}static isTextureLevelData(e){const t=null==e?void 0:e.data;return ArrayBuffer.isView(t)}static getTextureDataSize(e){if(!e)return null;if(ArrayBuffer.isView(e))return null;if(Array.isArray(e))return y.getTextureDataSize(e[0]);if(y.isExternalImage(e))return y.getExternalImageSize(e);if(e&&"object"==typeof e&&e.constructor===Object){const t=Object.values(e)[0];return{width:t.width,height:t.height}}throw new Error("texture size deduction failed")}static normalizeTextureData(e,t){let s;return s=ArrayBuffer.isView(e)?[{data:e,width:t.width,height:t.height}]:Array.isArray(e)?e:[e],s}static getMipLevelCount(e,t){return Math.floor(Math.log2(Math.max(e,t)))+1}static getCubeFaceDepth(e){switch(e){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(e)}}static normalizeProps(e,t){var s;const n={...t},i=(null==e||null==(s=e.props)||null==(s=s._resourceDefaults)?void 0:s.texture)||{};Object.assign(n,i);const{width:r,height:o}=n;return"number"==typeof r&&(n.width=Math.max(1,Math.ceil(r))),"number"==typeof o&&(n.height=Math.max(1,Math.ceil(o))),n}}y.COPY_SRC=1,y.COPY_DST=2,y.TEXTURE=4,y.STORAGE=8,y.RENDER_ATTACHMENT=16,y.CubeFaces=["+X","-X","+Y","-Y","+Z","-Z"],y.defaultProps={...m.F.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",width:void 0,height:void 0,depth:1,mipmaps:!1,compressed:!1,usage:0,mipLevels:void 0,samples:void 0,sampler:{},view:void 0,flipY:void 0},y.defaultCopyExternalImageOptions={image:void 0,sourceX:0,sourceY:0,width:void 0,height:void 0,depth:1,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1};class b extends m.F{get[Symbol.toStringTag](){return"Sampler"}constructor(e,t){super(e,t=b.normalizeProps(e,t),b.defaultProps)}static normalizeProps(e,t){var s;return{...t,...(null==e||null==(s=e.props)||null==(s=s._resourceDefaults)?void 0:s.sampler)||{}}}}b.defaultProps={...m.F.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"none",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1};const v={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},w={f32:4,f16:2,i32:4,u32:4};const _={uint8:"uint8",sint8:"sint8",unorm8:"uint8",snorm8:"sint8",uint16:"uint16",sint16:"sint16",unorm16:"uint16",snorm16:"sint16",float16:"float16",float32:"float32",uint32:"uint32",sint32:"sint32"},x={uint8:1,sint8:1,uint16:2,sint16:2,float16:2,float32:4,uint32:4,sint32:4};function L(e){let t;e.endsWith("-webgl")&&(e.replace("-webgl",""),t=!0);const[s,n]=e.split("x"),i=s,r=n?parseInt(n):1,o=function(e){const t=function(e){return x[e]}(_[e]),s=e.includes("norm"),n=!s&&!e.startsWith("float"),i=e.startsWith("s");return{dataType:_[e],byteLength:t,integer:n,signed:i,normalized:s}}(i),a={type:i,components:r,byteLength:o.byteLength*r,integer:o.integer,signed:o.signed,normalized:o.normalized};return t&&(a.webglOnly=!0),a}function A(e,t,s){const i=function(e,t){const s=e.attributes.find(e=>e.name===t);return s||n.warn(`shader layout attribute "${t}" not present in shader`),s||null}(e,s),r=function(e,t){C(e);let s=function(e,t){for(const s of e)if(s.format&&s.name===t)return{attributeName:s.name,bufferName:t,stepMode:s.stepMode,vertexFormat:s.format,byteOffset:0,byteStride:s.byteStride||0};return null}(e,t);return s||(s=function(e,t){for(const n of e){var s;let e=n.byteStride;if("number"!=typeof n.byteStride)for(const t of n.attributes||[])e+=L(t.format).byteLength;const i=null==(s=n.attributes)?void 0:s.find(e=>e.attribute===t);if(i)return{attributeName:i.attribute,bufferName:n.name,stepMode:n.stepMode,vertexFormat:i.format,byteOffset:i.byteOffset,byteStride:e}}return null}(e,t),s||(n.warn(`layout for attribute "${t}" not present in buffer layout`),null))}(t,s);if(!i)return null;const o=function(e){const[t,s]=v[e],n="i32"===t||"u32"===t,i="u32"!==t,r=w[t]*s,o=function(e,t){let s;switch(e){case"f32":s="float32";break;case"i32":s="sint32";break;case"u32":s="uint32";break;case"f16":return t<=2?"float16x2":"float16x4"}return 1===t?s:`${s}x${t}`}(t,s);return{dataType:t,components:s,defaultVertexFormat:o,byteLength:r,integer:n,signed:i}}(i.type),a=(null==r?void 0:r.vertexFormat)||o.defaultVertexFormat,u=L(a);return{attributeName:(null==r?void 0:r.attributeName)||i.name,bufferName:(null==r?void 0:r.bufferName)||i.name,location:i.location,shaderType:i.type,shaderDataType:o.dataType,shaderComponents:o.components,vertexFormat:a,bufferDataType:u.type,bufferComponents:u.components,normalized:u.normalized,integer:o.integer,stepMode:(null==r?void 0:r.stepMode)||i.stepMode||"vertex",byteOffset:(null==r?void 0:r.byteOffset)||0,byteStride:(null==r?void 0:r.byteStride)||0}}function C(e){for(const t of e)(t.attributes&&t.format||!t.attributes&&!t.format)&&n.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function S(e,t,s){if(!t||t>4)throw new Error(`size ${t}`);const n=t;let i=function(e){const t=ArrayBuffer.isView(e)?e.constructor:e;switch(t){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(t.constructor.name)}}(e);if("uint8"===i&&s&&1===n)return"unorm8-webgl";if("uint8"===i&&s&&3===n)return"unorm8x3-webgl";if("uint8"===i||"sint8"===i){if(1===n||3===n)throw new Error(`size: ${t}`);return s&&(i=i.replace("int","norm")),`${i}x${n}`}if("uint16"===i||"sint16"===i){if(1===n||3===n)throw new Error(`size: ${t}`);return s&&(i=i.replace("int","norm")),`${i}x${n}`}return 1===n?i:`${i}x${n}`}class $ extends m.F{get[Symbol.toStringTag](){return"RenderPipeline"}constructor(e,t){super(e,t,$.defaultProps),this.shaderLayout=void 0,this.bufferLayout=void 0,this.linkStatus="pending",this.hash="",this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}setUniformsWebGL(e){throw new Error("Use uniform blocks")}}$.defaultProps={...m.F.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",parameters:{},bindings:{},uniforms:{}};var I=s(54017);function O(e){return e.format?`${e.name}<${e.format.name}>`:e.name}const P={number:{type:"number",validate:(e,t)=>Number.isFinite(e)&&"object"==typeof t&&(void 0===t.max||e<=t.max)&&(void 0===t.min||e>=t.min)},array:{type:"array",validate:(e,t)=>Array.isArray(e)||ArrayBuffer.isView(e)}};function U(e){let t=M(e);if("object"!==t)return{value:e,...P[t],type:t};if("object"==typeof e)return e?void 0!==e.type?{...e,...P[e.type],type:e.type}:void 0===e.value?{type:"object",value:e}:(t=M(e.value),{...e,...P[t],type:t}):{type:"object",value:null};throw new Error("props")}function M(e){return Array.isArray(e)||ArrayBuffer.isView(e)?"array":typeof e}const T={vertex:"#ifdef MODULE_LOGDEPTH\n  logdepth_adjustPosition(gl_Position);\n#endif\n",fragment:"#ifdef MODULE_MATERIAL\n  fragColor = material_filterColor(fragColor);\n#endif\n\n#ifdef MODULE_LIGHTING\n  fragColor = lighting_filterColor(fragColor);\n#endif\n\n#ifdef MODULE_FOG\n  fragColor = fog_filterColor(fragColor);\n#endif\n\n#ifdef MODULE_PICKING\n  fragColor = picking_filterHighlightColor(fragColor);\n  fragColor = picking_filterPickingColor(fragColor);\n#endif\n\n#ifdef MODULE_LOGDEPTH\n  logdepth_setFragDepth();\n#endif\n"},D=/void\s+main\s*\([^)]*\)\s*\{\n?/,E=/}\n?[^{}]*$/,R=[],B="__LUMA_INJECT_DECLARATIONS__";function N(e){const t={vertex:{},fragment:{}};for(const s in e){let n=e[s];"string"==typeof n&&(n={order:0,injection:n}),t[F(s)][s]=n}return t}function F(e){const t=e.slice(0,2);switch(t){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(t)}}function j(e,t,s,n=!1){const i="vertex"===t;for(const t in s){const n=s[t];n.sort((e,t)=>e.order-t.order),R.length=n.length;for(let e=0,t=n.length;e<t;++e)R[e]=n[e].injection;const r=`${R.join("\n")}\n`;switch(t){case"vs:#decl":i&&(e=e.replace(B,r));break;case"vs:#main-start":i&&(e=e.replace(D,e=>e+r));break;case"vs:#main-end":i&&(e=e.replace(E,e=>r+e));break;case"fs:#decl":i||(e=e.replace(B,r));break;case"fs:#main-start":i||(e=e.replace(D,e=>e+r));break;case"fs:#main-end":i||(e=e.replace(E,e=>r+e));break;default:e=e.replace(t,e=>e+r)}}return e=e.replace(B,""),n&&(e=e.replace(/\}\s*$/,e=>e+T[t])),e}function k(e){e.map(e=>function(e){if(e.instance)return;k(e.dependencies||[]);const{propTypes:t={},deprecations:s=[],inject:n={}}=e,i={normalizedInjections:N(n),parsedDeprecations:W(s)};t&&(i.propValidators=function(e){const t={};for(const[s,n]of Object.entries(e))t[s]=U(n);return t}(t)),e.instance=i;let r={};t&&(r=Object.entries(t).reduce((e,[t,s])=>{const n=null==s?void 0:s.value;return n&&(e[t]=n),e},{})),e.defaultUniforms={...e.defaultUniforms,...r}}(e))}function G(e,t,s){var n;null==(n=e.deprecations)||n.forEach(e=>{var n;null!=(n=e.regex)&&n.test(t)&&(e.deprecated?s.deprecated(e.old,e.new)():s.removed(e.old,e.new)())})}function W(e){return e.forEach(e=>{"function"===e.type?e.regex=new RegExp(`\\b${e.old}\\(`):e.regex=new RegExp(`${e.type} ${e.old};`)}),e}function V(e){k(e);const t={},s={};H({modules:e,level:0,moduleMap:t,moduleDepth:s});const n=Object.keys(s).sort((e,t)=>s[t]-s[e]).map(e=>t[e]);return k(n),n}function H(e){const{modules:t,level:s,moduleMap:n,moduleDepth:i}=e;if(s>=5)throw new Error("Possible loop in shader dependency graph");for(const e of t)n[e.name]=e,(void 0===i[e.name]||i[e.name]<s)&&(i[e.name]=s);for(const e of t)e.dependencies&&H({modules:e.dependencies,level:s+1,moduleMap:n,moduleDepth:i})}const z=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,"#version 300 es\n"],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],X=[...z,[Z("attribute"),"in $1"],[Z("varying"),"out $1"]],Y=[...z,[Z("varying"),"in $1"]];function K(e,t){for(const[s,n]of t)e=e.replace(s,n);return e}function Z(e){return new RegExp(`\\b${e}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function J(e,t){let s="";for(const n in e){const i=e[n];if(s+=`void ${i.signature} {\n`,i.header&&(s+=`  ${i.header}`),t[n]){const e=t[n];e.sort((e,t)=>e.order-t.order);for(const t of e)s+=`  ${t.injection}\n`}i.footer&&(s+=`  ${i.footer}`),s+="}\n"}return s}function q(e){const t={vertex:{},fragment:{}};for(const s of e){let e,n;"string"!=typeof s?(e=s,n=e.hook):(e={},n=s),n=n.trim();const[i,r]=n.split(":"),o=n.replace(/\(.+/,""),a=Object.assign(e,{signature:r});switch(i){case"vs":t.vertex[o]=a;break;case"fs":t.fragment[o]=a;break;default:throw new Error(i)}}return t}function Q(e,t){if(!e)throw new Error(t||"shadertools: assertion failed.")}function ee(e,t="unnamed"){const s=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(e);return s?s[1]:t}function te(e){let t=100;const s=e.match(/[^\s]+/g);if(s&&s.length>=2&&"#version"===s[0]){const e=parseInt(s[1],10);Number.isFinite(e)&&(t=e)}if(100!==t&&300!==t)throw new Error(`Invalid GLSL version ${t}`);return t}const se=`\n\n${B}\n`;function ne(e,t){const{source:s,stage:n,modules:i,hookFunctions:r=[],inject:o={},log:a}=t;Q("string"==typeof s,"shader source must be a string");const u=s;let d="";const l=q(r),c={},f={},h={};for(const e in o){const t="string"==typeof o[e]?{injection:o[e],order:0}:o[e],s=/^(v|f)s:(#)?([\w-]+)$/.exec(e);if(s){const n=s[2],i=s[3];n?"decl"===i?f[e]=[t]:h[e]=[t]:c[e]=[t]}else h[e]=[t]}const p=i;for(const e of p){var m;a&&G(e,u,a),d+=oe(e,"wgsl");const t=(null==(m=e.injections)?void 0:m[n])||{};for(const e in t){const s=/^(v|f)s:#([\w-]+)$/.exec(e);if(s){const n="decl"===s[2]?f:h;n[e]=n[e]||[],n[e].push(t[e])}else c[e]=c[e]||[],c[e].push(t[e])}}return d+=se,d=j(d,n,f),d+=J(l[n],c),d+=u,d=j(d,n,h),d}function ie(e,t){const{id:s,source:n,stage:i,language:r="glsl",modules:o,defines:a={},hookFunctions:u=[],inject:d={},prologue:l=!0,log:c}=t;Q("string"==typeof n,"shader source must be a string");const f="glsl"===r?function(e){return{name:ee(e,void 0),language:"glsl",version:te(e)}}(n).version:-1,h=e.shaderLanguageVersion,p=100===f?"#version 100":"#version 300 es",m=n.split("\n").slice(1).join("\n"),g={};o.forEach(e=>{Object.assign(g,e.defines)}),Object.assign(g,a);let y="";switch(r){case"wgsl":break;case"glsl":y=l?`${p}\n\n// ----- PROLOGUE -------------------------\n${function(e){const{id:t,source:s,stage:n}=e;return t&&-1===s.indexOf("SHADER_NAME")?`\n#define SHADER_NAME ${t}_${n}`:""}({id:s,source:n,stage:i})}\n#define SHADER_TYPE_${i.toUpperCase()}\n\n${function(e){switch(null==e?void 0:e.gpu.toLowerCase()){case"apple":return"#define APPLE_GPU\n// Apple optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n";case"nvidia":return"#define NVIDIA_GPU\n// Nvidia optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n";case"intel":return"#define INTEL_GPU\n// Intel optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n// Intel's built-in 'tan' function doesn't have acceptable precision\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n";case"amd":return"#define AMD_GPU\n";default:return"#define DEFAULT_GPU\n// Prevent driver from optimizing away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n// Headless Chrome's software shader 'tan' function doesn't have acceptable precision\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// If the GPU doesn't have full 32 bits precision, will causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n"}}(e)}\n${"fragment"===i?"precision highp float;\n":""}\n\n// ----- APPLICATION DEFINES -------------------------\n\n${function(e={}){let t="";for(const s in e){const n=e[s];(n||Number.isFinite(n))&&(t+=`#define ${s.toUpperCase()} ${e[s]}\n`)}return t}(g)}\n\n`:`${p}\n`}const b=q(u),v={},w={},_={};for(const e in d){const t="string"==typeof d[e]?{injection:d[e],order:0}:d[e],s=/^(v|f)s:(#)?([\w-]+)$/.exec(e);if(s){const n=s[2],i=s[3];n?"decl"===i?w[e]=[t]:_[e]=[t]:v[e]=[t]}else _[e]=[t]}for(const e of o){var x;c&&G(e,m,c),y+=oe(e,i);const t=(null==(x=e.instance)?void 0:x.normalizedInjections[i])||{};for(const e in t){const s=/^(v|f)s:#([\w-]+)$/.exec(e);if(s){const n="decl"===s[2]?w:_;n[e]=n[e]||[],n[e].push(t[e])}else v[e]=v[e]||[],v[e].push(t[e])}}return y+="// ----- MAIN SHADER SOURCE -------------------------",y+=se,y=j(y,i,w),y+=J(b[i],v),y+=m,y=j(y,i,_),"glsl"===r&&f!==h&&(y=function(e,t){var s;if(300!==Number((null==(s=e.match(/^#version[ \t]+(\d+)/m))?void 0:s[1])||100))throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(t){case"vertex":return K(e,X);case"fragment":return K(e,Y);default:throw new Error(t)}}(y,i)),y.trim()}function re(e){return function(t){const s={};for(const n of e){const e=null==n.getUniforms?void 0:n.getUniforms(t,s);Object.assign(s,e)}return s}}function oe(e,t){let s;switch(t){case"vertex":s=e.vs||"";break;case"fragment":s=e.fs||"";break;case"wgsl":s=e.source||"";break;default:Q(!1)}if(!e.name)throw new Error("Shader module must have a name");const n=e.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");let i=`// ----- MODULE ${e.name} ---------------\n\n`;return"wgsl"!==t&&(i+=`#define MODULE_${n}\n`),i+=`${s}\n`,i}const ae=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,ue=/^\s*\#\s*endif\s*$/;class de{constructor(){this._hookFunctions=[],this._defaultModules=[]}static getDefaultShaderAssembler(){return de.defaultShaderAssembler=de.defaultShaderAssembler||new de,de.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(t=>t.name===("string"==typeof e?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){const t="string"==typeof e?e:e.name;this._defaultModules=this._defaultModules.filter(e=>e.name!==t)}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){const t=this._getModuleList(e.modules),s=this._hookFunctions,{source:n,getUniforms:i}=function(e){const t=V(e.modules||[]);return{source:ne(e.platformInfo,{...e,source:e.source,stage:"vertex",modules:t}),getUniforms:re(t)}}({...e,source:e.source,modules:t,hookFunctions:s}),r="wgsl"===e.platformInfo.shaderLanguage?function(e){const t=e.split("\n"),s=[];let n=!0,i=null;for(const e of t){const t=e.match(ae),r=e.match(ue);t?(i=t[1],n=Boolean(void 0)):r?n=!0:n&&s.push(e)}return s.join("\n")}(n):n;return{source:r,getUniforms:i,modules:t}}assembleGLSLShaderPair(e){const t=this._getModuleList(e.modules),s=this._hookFunctions,n=function(e){const{vs:t,fs:s}=e,n=V(e.modules||[]);return{vs:ie(e.platformInfo,{...e,source:t,stage:"vertex",modules:n}),fs:ie(e.platformInfo,{...e,source:s,stage:"fragment",modules:n}),getUniforms:re(n)}}({...e,vs:e.vs,fs:e.fs,modules:t,hookFunctions:s});return{...n,modules:t}}_getModuleList(e=[]){const t=new Array(this._defaultModules.length+e.length),s={};let n=0;for(let e=0,i=this._defaultModules.length;e<i;++e){const i=this._defaultModules[e],r=i.name;t[n++]=i,s[r]=!0}for(let i=0,r=e.length;i<r;++i){const r=e[i],o=r.name;s[o]||(t[n++]=r,s[o]=!0)}return t.length=n,k(t),t}}de.defaultShaderAssembler=void 0;var le=s(11173);class ce{constructor(e){if(this.id=void 0,this.userData={},this.topology=void 0,this.bufferLayout=[],this.vertexCount=void 0,this.indices=void 0,this.attributes=void 0,this.id=e.id||(0,le.L)("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&r.h.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){var e;null==(e=this.indices)||e.destroy();for(const e of Object.values(this.attributes))e.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}class fe extends m.F{get[Symbol.toStringTag](){return"ComputePipeline"}constructor(e,t){super(e,t,fe.defaultProps),this.hash="",this.shaderLayout=void 0,this.shaderLayout=t.shaderLayout}}fe.defaultProps={...m.F.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0};class he{static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new he(e),e._lumaData.defaultPipelineFactory}constructor(e){this.device=void 0,this.destroyPolicy=void 0,this._hashCounter=0,this._hashes={},this._renderPipelineCache={},this._computePipelineCache={},this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}createRenderPipeline(e){const t={...$.defaultProps,...e},s=this._hashRenderPipeline(t);if(!this._renderPipelineCache[s]){const e=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:void 0});e.hash=s,this._renderPipelineCache[s]={pipeline:e,useCount:0}}return this._renderPipelineCache[s].useCount++,this._renderPipelineCache[s].pipeline}createComputePipeline(e){const t={...fe.defaultProps,...e},s=this._hashComputePipeline(t);if(!this._computePipelineCache[s]){const e=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0});e.hash=s,this._computePipelineCache[s]={pipeline:e,useCount:0}}return this._computePipelineCache[s].useCount++,this._computePipelineCache[s].pipeline}release(e){const t=e.hash,s=e instanceof fe?this._computePipelineCache:this._renderPipelineCache;s[t].useCount--,0===s[t].useCount&&"unused"===this.destroyPolicy&&(s[t].pipeline.destroy(),delete s[t])}_hashComputePipeline(e){return`${this._getHash(e.shader.source)}`}_hashRenderPipeline(e){const t=e.vs?this._getHash(e.vs.source):0,s=e.fs?this._getHash(e.fs.source):0,n=this._getHash(JSON.stringify(e.bufferLayout));if("webgl"===this.device.type)return`${t}/${s}V-BL${n}`;{const i=this._getHash(JSON.stringify(e.parameters));return`${t}/${s}V-T${e.topology}P${i}BL${n}`}}_getHash(e){return void 0===this._hashes[e]&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}}he.defaultProps={...$.defaultProps};var pe=s(46190);function me(e,t,s,n){if(null!=n&&n.inlineSource){const n=function(e,t){let s="";for(let n=t-2;n<=t;n++){const i=e[n-1];void 0!==i&&(s+=ge(i,t,undefined))}return s}(t,s);return`\n${n}${e.linePos>0?`${" ".repeat(e.linePos+5)}^^^\n`:""}${e.type.toUpperCase()}: ${e.message}\n\n`}const i="error"===e.type?"red":"#8B4000";return null!=n&&n.html?`<div class='luma-compiler-log-error' style="color:${i};"><b> ${e.type.toUpperCase()}: ${e.message}</b></div>`:`${e.type.toUpperCase()}: ${e.message}`}function ge(e,t,s){const n=null!=s&&s.html?e.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"):e;return`${function(e){let t="";for(let s=e.length;s<4;++s)t+=" ";return t+e}(String(t))}: ${n}${null!=s&&s.html?"<br/>":"\n"}`}class ye extends m.F{get[Symbol.toStringTag](){return"Shader"}constructor(e,t){super(e,{id:be(t={...t,debugShaders:t.debugShaders||e.props.debugShaders||"errors"}),...t},ye.defaultProps),this.stage=void 0,this.source=void 0,this.compilationStatus="pending",this.stage=this.props.stage,this.source=this.props.source}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(){const e=this.props.debugShaders;switch(e){case"never":return;case"errors":if("success"===this.compilationStatus)return}const t=await this.getCompilationInfo();"warnings"===e&&0===(null==t?void 0:t.length)||this._displayShaderLog(t)}_displayShaderLog(e){var t,s;if("undefined"==typeof document||null==(t=document)||!t.createElement)return;const n=ve(this.source),i=`${this.stage} ${n}`;let r=function(e,t,s){let n="";const i=t.split(/\r?\n/),r=e.slice().sort((e,t)=>e.lineNum-t.lineNum);switch((null==s?void 0:s.showSourceCode)||"no"){case"all":let t=0;for(let e=1;e<=i.length;e++)for(n+=ge(i[e-1],e,s);r.length>t&&r[t].lineNum===e;){const e=r[t++];n+=me(e,i,e.lineNum,{...s,inlineSource:!1})}return n;case"issues":case"no":for(const t of e)n+=me(t,i,t.lineNum,{inlineSource:"no"!==(null==s?void 0:s.showSourceCode)});return n}}(e,this.source,{showSourceCode:"all",html:!0});const o=this.getTranslatedSource();o&&(r+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${o}</pre></code>`);const a=document.createElement("Button");a.innerHTML=`\n<h1>Shader Compilation Error in ${i}</h1><br /><br />\n<code style="user-select:text;"><pre>\n${r}\n</pre></code>`,a.style.top="10px",a.style.left="10px",a.style.position="absolute",a.style.zIndex="9999",a.style.width="100%",a.style.textAlign="left",document.body.appendChild(a),null==(s=document.getElementsByClassName("luma-compiler-log-error")[0])||s.scrollIntoView(),a.onclick=()=>{const e=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(e)}}}function be(e){return ve(e.source)||e.id||(0,pe.L)(`unnamed ${e.stage}-shader`)}function ve(e,t="unnamed"){const s=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(e);return s?s[1]:t}ye.defaultProps={...m.F.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debugShaders:void 0};class we{static getDefaultShaderFactory(e){return e._lumaData.defaultShaderFactory||=new we(e),e._lumaData.defaultShaderFactory}constructor(e){this.device=void 0,this.destroyPolicy=void 0,this._cache={},this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}createShader(e){const t=this._hashShader(e);let s=this._cache[t];if(!s){const n=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=s={shader:n,useCount:0}}return s.useCount++,s.shader}release(e){const t=this._hashShader(e),s=this._cache[t];s&&(s.useCount--,0===s.useCount&&"unused"===this.destroyPolicy&&(delete this._cache[t],s.shader.destroy()))}_hashShader(e){return`${e.stage}:${e.source}`}}we.defaultProps={...ye.defaultProps};let _e=null,xe=null;function Le(e,t,s){if(e===t)return!0;if(!s||!e||!t)return!1;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Le(e[n],t[n],s-1))return!1;return!0}if(Array.isArray(t))return!1;if("object"==typeof e&&"object"==typeof t){const n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(const i of n){if(!t.hasOwnProperty(i))return!1;if(!Le(e[i],t[i],s-1))return!1}return!0}return!1}var Ae=s(33864);function Ce(e){const t={bindings:{},uniforms:{}};return Object.keys(e).forEach(s=>{const n=e[s];var i;i=n,(0,Ae.H9)(i)||"number"==typeof i||"boolean"==typeof i?t.uniforms[s]=n:t.bindings[s]=n}),t}class Se{constructor(e,t){this.options={disableWarnings:!1},this.modules=void 0,this.moduleUniforms=void 0,this.moduleBindings=void 0,Object.assign(this.options,t);const s=V(Object.values(e).filter(e=>e.dependencies));for(const t of s)e[t.name]=t;n.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[t,s]of Object.entries(e))this._addModule(s),s.name&&t!==s.name&&!this.options.disableWarnings&&n.warn(`Module name: ${t} vs ${s.name}`)()}destroy(){}setProps(e){for(const t of Object.keys(e)){const s=t,i=e[s]||{},r=this.modules[s];if(!r){this.options.disableWarnings||n.warn(`Module ${t} not found`)();continue}const o=this.moduleUniforms[s],a=this.moduleBindings[s],u=(null==r.getUniforms?void 0:r.getUniforms(i,o))||i,{uniforms:d,bindings:l}=Ce(u);this.moduleUniforms[s]={...o,...d},this.moduleBindings[s]={...a,...l}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){const e={};for(const t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){const e={};for(const[s,n]of Object.entries(this.moduleUniforms))for(const[i,r]of Object.entries(n)){var t;e[`${s}.${i}`]={type:null==(t=this.modules[s].uniformTypes)?void 0:t[i],value:String(r)}}return e}_addModule(e){const t=e.name;this.moduleUniforms[t]=e.defaultUniforms||{},this.moduleBindings[t]={}}}async function $e(e,t){const s=new Image;return s.crossOrigin=(null==t?void 0:t.crossOrigin)||"anonymous",s.src=e.startsWith("http")?e:""+e,await s.decode(),t?await createImageBitmap(s,t):await createImageBitmap(s)}class Ie{get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}constructor(e,t){var s;this.device=void 0,this.id=void 0,this.texture=void 0,this.sampler=void 0,this.view=void 0,this.ready=void 0,this.isReady=!1,this.destroyed=!1,this.resolveReady=()=>{},this.rejectReady=()=>{},this.device=e,this.id=t.id||(0,le.L)("async-texture"),"string"==typeof(null==(s=t)?void 0:s.data)&&"2d"===t.dimension&&(t={...t,data:$e(t.data)}),this.ready=new Promise((e,t)=>{this.resolveReady=()=>{this.isReady=!0,e()},this.rejectReady=t}),this.initAsync(t)}async initAsync(e){const t=e.data;let s;try{s=await Oe(t)}catch(e){this.rejectReady(e)}if(this.destroyed)return;const n={...e,data:s};this.texture=this.device.createTexture(n),this.sampler=this.texture.sampler,this.view=this.texture.view,this.isReady=!0,this.resolveReady()}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}resize(e){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){const t=this.texture;this.texture=t.clone(e),t.destroy()}return!0}}async function Oe(e){if(e=await e,Array.isArray(e))return await Promise.all(e.map(Oe));if(e&&"object"==typeof e&&e.constructor===Object){const t=e,s=await Promise.all(Object.values(t)),n=Object.keys(t),i={};for(let e=0;e<n.length;e++)i[n[e]]=s[e];return i}return e}class Pe{get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}constructor(e,t){var s,i,r;this.device=void 0,this.id=void 0,this.source=void 0,this.vs=void 0,this.fs=void 0,this.pipelineFactory=void 0,this.shaderFactory=void 0,this.userData={},this.parameters=void 0,this.topology=void 0,this.bufferLayout=void 0,this.isInstanced=void 0,this.instanceCount=0,this.vertexCount=void 0,this.indexBuffer=null,this.bufferAttributes={},this.constantAttributes={},this.bindings={},this.uniforms={},this.vertexArray=void 0,this.transformFeedback=null,this.pipeline=void 0,this.shaderInputs=void 0,this._uniformStore=void 0,this._attributeInfos={},this._gpuGeometry=null,this._getModuleUniforms=void 0,this.props=void 0,this._pipelineNeedsUpdate="newly created",this._needsRedraw="initializing",this._destroyed=!1,this._lastDrawTimestamp=-1,this._lastLogTime=0,this._logOpen=!1,this._drawCount=0,this.props={...Pe.defaultProps,...t},t=this.props,this.id=t.id||(0,le.L)("model"),this.device=e,Object.assign(this.userData,t.userData);const o=Object.fromEntries((null==(s=this.props.modules)?void 0:s.map(e=>[e.name,e]))||[]),a=t.shaderInputs||new Se(o,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(a);const u=function(e){return{type:e.type,shaderLanguage:e.info.shadingLanguage,shaderLanguageVersion:e.info.shadingLanguageVersion,gpu:e.info.gpu,features:e.features}}(e),d=((null==(i=this.props.modules)?void 0:i.length)>0?this.props.modules:null==(r=this.shaderInputs)?void 0:r.getModules())||[];if("webgpu"===this.device.type&&this.props.source){const{source:e,getUniforms:t}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:u,...this.props,modules:d});this.source=e,this._getModuleUniforms=t,this.props.shaderLayout||=function(e){const t={attributes:[],bindings:[]};let s;try{s=function(e){try{return new I.$X(e)}catch(e){if(e instanceof Error)throw e;let t="WGSL parse error";throw"object"==typeof e&&null!=e&&e.message&&(t+=`: ${e.message} `),"object"==typeof e&&null!=e&&e.token&&(t+=e.token.line||""),new Error(t,{cause:e})}}(e)}catch(e){return n.error(e.message)(),t}for(const e of s.uniforms){const s=[];for(const t of(null==(i=e.type)?void 0:i.members)||[]){var i;s.push({name:t.name,type:O(t.type)})}t.bindings.push({type:"uniform",name:e.name,group:e.group,location:e.binding,members:s})}for(const e of s.textures)t.bindings.push({type:"texture",name:e.name,group:e.group,location:e.binding});for(const e of s.samplers)t.bindings.push({type:"sampler",name:e.name,group:e.group,location:e.binding});const r=s.entry.vertex[0],o=(null==r?void 0:r.inputs.length)||0;for(let e=0;e<o;e++){const s=r.inputs[e];if("location"===s.locationType){const e=O(s.type);t.attributes.push({name:s.name,location:Number(s.location),type:e})}}return t}(this.source)}else{const{vs:e,fs:t,getUniforms:s}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:u,...this.props,modules:d});this.vs=e,this.fs=t,this._getModuleUniforms=s}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||he.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||we.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.uniforms&&this.setUniformsWebGL(t.uniforms),t.moduleSettings&&this.updateModuleSettingsWebGL(t.moduleSettings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}destroy(){var e;this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),null==(e=this._gpuGeometry)||e.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||=e}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){const t=this._areBindingsLoading();if(t)return n.info(2,`>>> DRAWING ABORTED ${this.id}: ${t} not loaded`)(),!1;try{e.pushDebugGroup(`${this}.predraw(${e})`),this.predraw()}finally{e.popDebugGroup()}let s;try{e.pushDebugGroup(`${this}.draw(${e})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();const t=this._getBindings();this.pipeline.setBindings(t,{disableWarnings:this.props.disableWarnings}),Me(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:n}=this.vertexArray,i=n?n.byteLength/("uint32"===n.indexType?4:2):void 0;s=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:i,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{e.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(e),s?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",s}setGeometry(e){var t;null==(t=this._gpuGeometry)||t.destroy();const s=e&&function(e,t){if(t instanceof ce)return t;const s=function(e,t){if(!t.indices)return;const s=t.indices.value;return e.createBuffer({usage:r.h.INDEX,data:s})}(e,t),{attributes:n,bufferLayout:i}=function(e,t){const s=[],n={};for(const[i,r]of Object.entries(t.attributes)){let t=i;switch(i){case"POSITION":t="positions";break;case"NORMAL":t="normals";break;case"TEXCOORD_0":t="texCoords";break;case"COLOR_0":t="colors"}if(r){n[t]=e.createBuffer({data:r.value,id:`${i}-buffer`});const{value:o,size:a,normalized:u}=r;s.push({name:t,format:S(o,a,u)})}}return{attributes:n,bufferLayout:s,vertexCount:t._calculateVertexCount(t.attributes,t.indices)}}(e,t);return new ce({topology:t.topology||"triangle-list",bufferLayout:i,vertexCount:t.vertexCount,indices:s,attributes:n})}(this.device,e);if(s){this.setTopology(s.topology||"triangle-list");const e=new i(this.bufferLayout);this.bufferLayout=e.mergeBufferLayouts(s.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(s)}this._gpuGeometry=s}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){const t=new i(this.bufferLayout);this.bufferLayout=this._gpuGeometry?t.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){Le(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,void 0===this.isInstanced&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new p(this.shaderInputs.modules);for(const[e,t]of Object.entries(this.shaderInputs.modules))if(Ue(t)){const t=this._uniformStore.getManagedUniformBuffer(this.device,e);this.bindings[`${e}Uniforms`]=t}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){var s;const r=null!=(s=null==t?void 0:t.disableWarnings)?s:this.props.disableWarnings;e.indices&&n.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)(),this.bufferLayout=function(e,t){const s=Object.fromEntries(e.attributes.map(e=>[e.name,e.location])),n=t.slice();return n.sort((e,t)=>{const n=e.attributes?e.attributes.map(e=>e.attribute):[e.name],i=t.attributes?t.attributes.map(e=>e.attribute):[t.name];return Math.min(...n.map(e=>s[e]))-Math.min(...i.map(e=>s[e]))}),n}(this.pipeline.shaderLayout,this.bufferLayout);const o=new i(this.bufferLayout);for(const[t,s]of Object.entries(e)){const e=o.getBufferLayout(t);if(!e){r||n.warn(`Model(${this.id}): Missing layout for buffer "${t}".`)();continue}const i=o.getAttributeNamesForBuffer(e);let a=!1;for(const e of i){const t=this._attributeInfos[e];if(t){const e="webgpu"===this.device.type?o.getBufferIndex(t.bufferName):t.location;this.vertexArray.setBuffer(e,s),a=!0}}a||r||n.warn(`Model(${this.id}): Ignoring buffer "${s.id}" for unknown attribute "${t}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(const[i,r]of Object.entries(e)){var s;const e=this._attributeInfos[i];e?this.vertexArray.setConstantWebGL(e.location,r):(null!=(s=null==t?void 0:t.disableWarnings)?s:this.props.disableWarnings)||n.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${i}"`)()}this.setNeedsRedraw("constants")}setUniforms(e){this.setUniformsWebGL(e)}setUniformsWebGL(e){Me(e)||(this.pipeline.setUniformsWebGL(e),Object.assign(this.uniforms,e)),this.setNeedsRedraw("uniforms")}updateModuleSettingsWebGL(e){const{bindings:t,uniforms:s}=Ce(this._getModuleUniforms(e));Object.assign(this.bindings,t),Object.assign(this.uniforms,s),this.setNeedsRedraw("moduleSettings")}_areBindingsLoading(){for(const e of Object.values(this.bindings))if(e instanceof Ie&&!e.isReady)return e.id;return!1}_getBindings(){const e={};for(const[t,s]of Object.entries(this.bindings))s instanceof Ie?s.isReady&&(e[t]=s.texture):e[t]=s;return e}_getBindingsUpdateTimestamp(){let e=0;for(const t of Object.values(this.bindings))t instanceof g?e=Math.max(e,t.texture.updateTimestamp):t instanceof r.h||t instanceof y?e=Math.max(e,t.updateTimestamp):t instanceof Ie?e=t.texture?Math.max(e,t.texture.updateTimestamp):1/0:t instanceof b||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const t={...e.attributes};for(const[e]of Object.entries(t))this.pipeline.shaderLayout.attributes.find(t=>t.name===e)||"positions"===e||delete t[e];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||=e,this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(n.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const s=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders});let i=null;this.source?i=s:this.fs&&(i=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:s,fs:i}),this._attributeInfos=function(e,t){const s={};for(const n of e.attributes){const i=A(e,t,n.name);i&&(s[n.name]=i)}return s}(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_logDrawCallStart(){const e=n.level>3?0:1e4;n.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,n.group(2,`>>> DRAWING MODEL ${this.id}`,{collapsed:n.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=function(e){var t;const s={},n="Values";if(0===e.attributes.length&&(null==(t=e.varyings)||!t.length))return{"No attributes or varyings":{[n]:"N/A"}};for(const t of e.attributes)t&&(s[`in ${t.location} ${t.name}: ${t.type}`]={[n]:t.stepMode||"vertex"});for(const t of e.varyings||[])s[`out ${t.location} ${t.name}`]={[n]:JSON.stringify(t)};return s}(this.pipeline.shaderLayout,this.id);n.table(2,e)();const t=this.shaderInputs.getDebugTable();for(const[e,s]of Object.entries(this.uniforms))t[e]={value:s};n.table(2,t)();const s=this._getAttributeDebugTable();n.table(2,this._attributeInfos)(),n.table(2,s)(),n.groupEnd(2)(),this._logOpen=!1}}_logFramebuffer(e){const t=this.device.props.debugFramebuffers;if(this._drawCount++,!t)return;const s=e.props.framebuffer;s&&function(e,{id:t,minimap:s,opaque:n,top:i="0",left:r="0",rgbaScale:o=1}){var a;_e||(_e=document.createElement("canvas"),_e.id=t,_e.title=t,_e.style.zIndex="100",_e.style.position="absolute",_e.style.top=i,_e.style.left=r,_e.style.border="blue 5px solid",_e.style.transform="scaleY(-1)",document.body.appendChild(_e),xe=_e.getContext("2d")),_e.width===e.width&&_e.height===e.height||(_e.width=e.width/2,_e.height=e.height/2,_e.style.width="400px",_e.style.height="400px");const u=e.device.readPixelsToArrayWebGL(e),d=null==(a=xe)?void 0:a.createImageData(e.width,e.height);if(d){var l;const e=0;for(let t=0;t<u.length;t+=4)d.data[e+t+0]=u[t+0]*o,d.data[e+t+1]=u[t+1]*o,d.data[e+t+2]=u[t+2]*o,d.data[e+t+3]=n?255:u[t+3]*o;null==(l=xe)||l.putImageData(d,0,0)}}(s,{id:s.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[t,s]of Object.entries(this._attributeInfos)){const n=this.vertexArray.attributes[s.location];e[s.location]={name:t,type:s.shaderType,values:n?this._getBufferOrConstantValues(n,s.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){const{indexBuffer:t}=this.vertexArray,s="uint32"===t.indexType?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:s.toString()}}return e}_getBufferOrConstantValues(e,t){const s=function(e){switch(e){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(e)}}(t);return(e instanceof r.h?new s(e.debugData):e).toString()}}function Ue(e){return Boolean(e.uniformTypes&&!Me(e.uniformTypes))}function Me(e){for(const t in e)return!1;return!0}Pe.defaultProps={...$.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:de.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0}},65019:(e,t,s)=>{s.d(t,{Wk:()=>i});const n="#version 300 es\nout vec4 transform_output;\nvoid main() {\n  transform_output = vec4(0);\n}";function i(e){const{input:t,inputChannels:s,output:i}=e||{};if(!t)return n;if(!s)throw new Error("inputChannels");return`#version 300 es\nin ${function(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${e}`)}}(s)} ${t};\nout vec4 ${i};\nvoid main() {\n  ${i} = ${function(e,t){switch(t){case 1:return`vec4(${e}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${e}, 0.0, 1.0)`;case 3:return`vec4(${e}, 1.0)`;case 4:return e;default:throw new Error(`invalid channels: ${t}`)}}(t,s)};\n}`}},65618:(e,t,s)=>{s.d(t,{F:()=>i});var n=s(46190);class i{toString(){return`${this[Symbol.toStringTag]||this.constructor.name}:"${this.id}"`}constructor(e,t,s){if(this.id=void 0,this.props=void 0,this.userData={},this._device=void 0,this.destroyed=!1,this.allocatedBytes=0,this._attachedResources=new Set,!e)throw new Error("no device");this._device=e,this.props=function(e,t){const s={...t};for(const t in e)void 0!==e[t]&&(s[t]=e[t]);return s}(t,s);const i="undefined"!==this.props.id?this.props.id:(0,n.L)(this[Symbol.toStringTag]);this.props.id=i,this.id=i,this.userData=this.props.userData||{},this.addStats()}destroy(){this.destroyResource()}delete(){return this.destroy(),this}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get(`${t}s Active`).decrementCount()}trackAllocatedMemory(e,t=this[Symbol.toStringTag]){const s=this._device.statsManager.getStats("Resource Counts");s.get("GPU Memory").addCount(e),s.get(`${t} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const t=this._device.statsManager.getStats("Resource Counts");t.get("GPU Memory").subtractCount(this.allocatedBytes),t.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${t}s Created`).incrementCount(),e.get(`${t}s Active`).incrementCount()}}i.defaultProps={id:"undefined",handle:void 0,userData:void 0}}}]);